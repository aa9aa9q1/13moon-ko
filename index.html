<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>í† íŠ¸ì˜ ë‹¬ë ¥ - 13 Moon Calendar (White Wizard)</title>

<link rel="manifest" href="./manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="í† íŠ¸ì˜ ë‹¬ë ¥">

<link rel="icon" href="./dreamspell_icon_512.png" sizes="512x512">
<link rel="apple-touch-icon" href="./dreamspell_icon_512.png">

<link rel="stylesheet" href="./src/assets/dreamspell.css" />

<style>
  :root{--bg:#0b0b0c;--fg:#e9e9ea;--muted:#9aa0a6;--card:#141518;--acc:#cfd8e3;--line:#23252a}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Apple SD Gothic Neo,sans-serif}
  .wrap{max-width:880px;margin:0 auto;padding:16px 16px 96px}
  h1{font-size:22px;margin:0 0 6px;font-weight:800;letter-spacing:.2px}
  h2{font-size:18px;margin:0 0 10px}
  .muted{color:var(--muted)}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin:12px 0}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  input,button{border-radius:10px;border:1px solid #2a2c33;background:#1a1c21;color:var(--fg);padding:10px 12px}
  button.primary{background:#1b2a33;border-color:#24414f}
  .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:10px}
  .cell{background:#13151a;border:1px solid #262b31;border-radius:10px;padding:8px;min-height:62px;display:flex;flex-direction:column;justify-content:center;align-items:center}
  .cell .gd{font-weight:800;font-size:16px}
  .cell .md{font-size:12px;color:var(--muted)}
  .big{font-size:28px;font-weight:800;letter-spacing:0.2px}
  .kinfo{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
  .kbadge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:9px;background:#101318;border:1px solid #28303a;cursor:pointer}
  .row > *{flex:1 1 auto}
  .split{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:780px){.split{grid-template-columns:1.2fr .8fr}}
  .hint{font-size:13px;color:var(--muted)}
  .doot{padding:16px;border:1px dashed #3a404a;border-radius:12px;background:#101216}
  .iconwrap{display:inline-flex;align-items:center;justify-content:center}
  .is-today{outline:2px solid var(--acc);}
  .pill{display:inline-block; padding:4px 8px; border:1px solid #2c323a; border-radius:999px; background:#0f1216; font-size:12px; color:var(--muted)}
  .pop{position:fixed;max-width:300px;background:#101318;border:1px solid #2a2f36;border-radius:10px;padding:10px 12px;box-shadow:0 6px 30px rgba(0,0,0,.35);z-index:9999;font-size:14px;line-height:1.45}
  .pop .ttl{font-weight:800;margin-bottom:6px}
  .pop .sub{font-size:12px;color:var(--muted);margin-top:6px}
  .pop::after{content:"";position:absolute;width:10px;height:10px;background:#101318;border-left:1px solid #2a2f36;border-top:1px solid #2a2f36;transform:rotate(45deg)}
  .pop[data-side="top"]::after{bottom:-6px;left:16px}
  .tabbar{position:fixed;left:0;right:0;bottom:0;background:#0d0e11;border-top:1px solid #1f232a;display:flex}
  .tabbar button{flex:1;padding:12px 8px;background:transparent;border:0;color:var(--fg);font-weight:800}
  .tabbar button[aria-selected="true"]{background:#121419}
  .page{display:none}
  .page.active{display:block}
  .wavechip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid #2b2f37;background:#0f1216}
  .wave-red{color:#E75A4A}.wave-white{color:#EDEFF2}.wave-blue{color:#3D9CEA}.wave-yellow{color:#F6C542}
</style>
</head>
<body>
<div class="wrap">
  <h1>í† íŠ¸ì˜ ë‹¬ë ¥ <span class="muted">â€“ 13 Moon Calendar (White Wizard)</span></h1>

  <section id="page-calendar" class="page active">
    <div class="card">
      <div class="row">
        <input type="date" id="datePick" />
        <button class="primary" id="btnToday">ì˜¤ëŠ˜</button>
        <button id="btnShare">ê³µìœ </button>
      </div>
      <div id="todayCard" style="margin-top:10px"></div>
    </div>

    <div class="split">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <h2>ì´ ë‹¬(28ì¼ ê·¸ë¦¬ë“œ)</h2>
          <span id="legend" class="pill">ì…€=ì–‘ë ¥ / í•˜ë‹¨=13ë¬¸ M.D</span>
        </div>
        <div id="moonMeta" class="muted" style="margin:6px 0 10px"></div>
        <div id="grid" class="grid"></div>
        <div class="hint" style="margin-top:8px">* 13Ã—28=364. 7/25ëŠ” â€œì‹œê°„ ë°–ì˜ ë‚ â€.</div>
      </div>

      <div class="card">
        <h2>ê¸°ì¤€ & ì˜¤ëŠ˜ì˜ ì œì•ˆ</h2>
        <div class="row">
          <label style="flex:1">ê¸°ì¤€ì¼
            <input type="date" id="baseDate">
          </label>
          <label style="flex:1">ê¸°ì¤€ Kin
            <input type="number" id="baseKin" min="1" max="260">
          </label>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="btnSaveBase" class="primary">ì €ì¥</button>
          <button id="btnResetBase">ê¸°ë³¸ê°’</button>
        </div>

        <div class="card" style="margin-top:12px">
          <h3 style="margin:0 0 6px">ì˜¤ëŠ˜ì˜ ì œì•ˆ</h3>
          <div id="advice"></div>
        </div>
      </div>
    </div>
  </section>

  <section id="page-user" class="page">
    <div class="card">
      <h2>ë‚´ ì •ë³´ (ì€í•˜ ì„œëª…)</h2>
      <div class="row" style="margin-top:6px">
        <label style="flex:1">ì´ë¦„(ì„ íƒ)
          <input type="text" id="userName" placeholder="ë³„ëª… ë˜ëŠ” ì´ë¦„">
        </label>
        <label style="flex:1">ìƒì¼(ì–‘ë ¥)
          <input type="date" id="userBirth">
        </label>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="btnSaveUser" class="primary">ì €ì¥</button>
        <button id="btnClearUser">ì§€ìš°ê¸°</button>
      </div>

      <div id="userResult" class="card" style="margin-top:12px; display:none">
        <h3 style="margin:0 0 6px">ë‚˜ì˜ ë“œë¦¼ìŠ¤í  í”„ë¡œí•„</h3>
        <div class="kv">
          <div class="muted">ì€í•˜ ì„œëª…</div>
          <div id="u_kin"></div>

          <div class="muted">ì›¨ì´ë¸ŒìŠ¤í </div>
          <div id="u_wave"></div>

          <div class="muted">íƒ„ìƒ 13ë¬¸ ë‚ ì§œ</div>
          <div id="u_moon"></div>
        </div>
      </div>
    </div>
  </section>
</div>

<nav class="tabbar">
  <button id="tabCal" aria-selected="true">ìº˜ë¦°ë”</button>
  <button id="tabUser" aria-selected="false">ë‚˜</button>
</nav>

<script>
(function(){
  const MOON_NAMES = ["1 ìê°ì˜ ë‹¬","2 ë„ì „ì˜ ë‹¬","3 ì„œë¹„ìŠ¤ì˜ ë‹¬","4 ìê¸°(í˜•íƒœ)ì˜ ë‹¬","5 í˜ì˜ ë‹¬","6 ê· í˜•ì˜ ë‹¬","7 ê³µëª…ì˜ ë‹¬","8 ë¬´ê²°ì„±ì˜ ë‹¬","9 ì˜ë„ì˜ ë‹¬","10 í˜„í˜„ì˜ ë‹¬","11 í•´ë°©ì˜ ë‹¬","12 í˜‘ë ¥ì˜ ë‹¬","13 ìš°ì£¼ì˜ ë‹¬"];
  const TONE_NAMES = ["1 ìê¸°","2 ë‹¬","3 ì „ê¸°","4 ìê¸°(í˜•íƒœ)","5 ë°œì‚°","6 ë¦¬ë“¬","7 ê³µëª…","8 ì€í•˜","9 íƒœì–‘","10 í–‰ì„±","11 ìŠ¤í™íŠ¸ëŸ´(í•´ë°©)","12 ìˆ˜ì •(í˜‘ë ¥)","13 ìš°ì£¼"];
  const SEAL_NAMES = ["1 ë¶‰ì€ ìš©","2 í° ë°”ëŒ","3 íŒŒë€ ë°¤","4 ë…¸ë€ ì”¨ì•—","5 ë¶‰ì€ ë±€","6 í° ì„¸ê³„ì—°ê²°ì","7 íŒŒë€ ì†","8 ë…¸ë€ ë³„","9 ë¶‰ì€ ë‹¬","10 í° ê°œ","11 íŒŒë€ ì›ìˆ­ì´","12 ë…¸ë€ ì¸ê°„","13 ë¶‰ì€ í•˜ëŠ˜ì—¬í–‰ì","14 í° ë§ˆë²•ì‚¬","15 íŒŒë€ ë…ìˆ˜ë¦¬","16 ë…¸ë€ ì „ì‚¬","17 ë¶‰ì€ ì§€êµ¬","18 í° ê±°ìš¸","19 íŒŒë€ í­í’","20 ë…¸ë€ íƒœì–‘"];
  const SEAL_SLUGS = ["01_red-dragon","02_white-wind","03_blue-night","04_yellow-seed","05_red-serpent","06_white-worldbridger","07_blue-hand","08_yellow-star","09_red-moon","10_white-dog","11_blue-monkey","12_yellow-human","13_red-skywalker","14_white-wizard","15_blue-eagle","16_yellow-warrior","17_red-earth","18_white-mirror","19_blue-storm","20_yellow-sun"];
  const SEAL_COLOR = ["seal-red","seal-white","seal-blue","seal-yellow","seal-red","seal-white","seal-blue","seal-yellow","seal-red","seal-white","seal-blue","seal-yellow","seal-red","seal-white","seal-blue","seal-yellow","seal-red","seal-white","seal-blue","seal-yellow"];
  const WAVE_NAMES = ["ë¶‰ì€ ìš©","í° ë°”ëŒ","íŒŒë€ ë°¤","ë…¸ë€ ì”¨ì•—","ë¶‰ì€ ë±€","í° ì„¸ê³„ì—°ê²°ì","íŒŒë€ ì†","ë…¸ë€ ë³„","ë¶‰ì€ ë‹¬","í° ê°œ","íŒŒë€ ì›ìˆ­ì´","ë…¸ë€ ì¸ê°„","ë¶‰ì€ í•˜ëŠ˜ì—¬í–‰ì","í° ë§ˆë²•ì‚¬","íŒŒë€ ë…ìˆ˜ë¦¬","ë…¸ë€ ì „ì‚¬","ë¶‰ì€ ì§€êµ¬","í° ê±°ìš¸","íŒŒë€ í­í’","ë…¸ë€ íƒœì–‘"];
  const WAVE_COLOR = ["wave-red","wave-white","wave-blue","wave-yellow","wave-red","wave-white","wave-blue","wave-yellow","wave-red","wave-white","wave-blue","wave-yellow","wave-red","wave-white","wave-blue","wave-yellow","wave-red","wave-white","wave-blue","wave-yellow"];

  const TONE_BRIEF = ["ëª©ì Â·ì˜ì§€Â·í˜„ì¡´","ë„ì „Â·ê·¹ì„±Â·ê· í˜•","ë´‰ì‚¬Â·í™œì„±Â·ì˜ë„","í˜•íƒœÂ·ì •ì˜Â·í˜•ìƒí™”","í˜Â·ë³µì œÂ·ë°©ì‚¬","íë¦„Â·ê· í˜•Â·ì¡°ìœ¨","ê³µëª…Â·ì±„ë„ë§Â·ì¡°ìœ¨","ëª¨ë¸Â·ë¬´ê²°ì„±Â·ì¡°í™”","ì‹¤í˜„Â·ì˜ë„Â·ë¹›","í˜„í˜„Â·ì™„ì„±Â·ìƒì‚°","í•´ë°©Â·ìš©í•´Â·í•´ì²´","í˜‘ë ¥Â·ì¡°í•©Â·í—Œì‹ ","ìš°ì£¼Â·ì¡´ì¬Â·ì´ˆì›”"];
  const SEAL_BRIEF = ["íƒ„ìƒÂ·ì–‘ìœ¡Â·ê¸°ì´ˆ","ì†Œí†µÂ·í˜¸í¡Â·ì˜ê°","ê¿ˆÂ·í’ìš”Â·ì ì¬ì˜ì‹","ì”¨ì•—Â·ë°œì•„Â·ì ì¬ë ¥","ìƒëª…ë ¥Â·ë³¸ëŠ¥Â·ì •í™”","ë†“ì•„ë³´ëƒ„Â·ì£½ìŒÂ·ê¸°íšŒ","ì¹˜ìœ Â·ì™„ì„±Â·ì§€ì‹","ì•„ë¦„ë‹¤ì›€Â·ì˜ˆìˆ Â·ì¡°í™”","ì •í™”Â·íë¦„Â·ë¬¼","ì‚¬ë‘Â·ì¶©ì„±Â·ë§ˆìŒ","ìœ í¬Â·ë§ˆë²•Â·ì¬ì¹˜","ììœ ì˜ì§€Â·ì§€í˜œÂ·ì˜í–¥","íƒí—˜Â·ê³µê°„Â·ê°ì„±","ì£¼ìˆ Â·ì‹œê°„Â·ìˆ˜ìš©","ë¹„ì „Â·ì°½ê³µÂ·ë§ˆìŒì˜ ëˆˆ","ì§ˆë¬¸Â·ì§€ì„±Â·ëŒ€ë‹´","ë™ê¸°í™”Â·í•­ë²•Â·ì§€êµ¬","ë°˜ì˜Â·ì§ˆì„œÂ·ê²½ê³„","ë³€í˜•Â·ì´‰ë§¤Â·ì—ë„ˆì§€","ê³„ëª½Â·ìƒëª…Â·ë³´í¸ì  ë¶ˆ"];

  const DEFAULT_BASE = { baseDate: "2025-07-26", baseKin: 34 };

  const toUTC=(y,m,d)=>new Date(Date.UTC(y,m-1,d));
  const ymd=(d)=>({y:d.getUTCFullYear(),m:d.getUTCMonth()+1,d:d.getUTCDate()});
  const parseYMD=(s)=>{const [y,m,d]=s.split("-").map(Number);return toUTC(y,m,d)};
  const fmt2=(n)=>String(n).padStart(2,"0");
  const fmtYMD=(d)=>{const o=ymd(d);return [o.y,fmt2(o.m),fmt2(o.d)].join("-")};
  const sameUTC=(a,b)=>a.getUTCFullYear()===b.getUTCFullYear()&&a.getUTCMonth()===b.getUTCMonth()&&a.getUTCDate()===b.getUTCDate();
  const diffDaysUTC=(a,b)=>Math.floor((a-b)/86400000);

  const getBase=()=>{try{const j=JSON.parse(localStorage.getItem("kin-base")||"{}");return (j.baseDate&&j.baseKin)?j:DEFAULT_BASE}catch(e){return DEFAULT_BASE}};
  const saveBase=(b)=>localStorage.setItem("kin-base", JSON.stringify(b));
  const getUser=()=>{try{return JSON.parse(localStorage.getItem("user-profile")||"{}")}catch(e){return {}}};
  const saveUser=(u)=>localStorage.setItem("user-profile", JSON.stringify(u));

  function toThirteenMoon(date){
    const {y}=ymd(date);
    const doot=toUTC(y,7,25);
    if(sameUTC(date,doot)) return {isDOOT:true};
    const startThis=toUTC(y,7,26);
    const start=(date<startThis)?toUTC(y-1,7,26):startThis;
    const offset=diffDaysUTC(date,start);
    return {isDOOT:false, month:Math.floor(offset/28)+1, day:(offset%28)+1, start};
  }

  function kinOf(date, base){
    const baseDate=parseYMD(base.baseDate);
    const days=diffDaysUTC(date, baseDate);
    const kin=((days+base.baseKin-1)%260+260)%260+1;
    const tone=((kin-1)%13)+1;
    const seal=((kin-1)%20)+1;
    const waveIndex=Math.floor((kin-1)/13);
    const wavePos=((kin-1)%13)+1;
    const waveSeal=waveIndex%20+1;
    return {kin,tone,seal,waveIndex,wavePos,waveSeal};
  }

  function inlineSVG(el,src,klass=""){
    fetch(src).then(r=>r.text()).then(txt=>{
      el.innerHTML=txt; if(klass) el.className += " "+klass;
      const svg=el.querySelector("svg"); if(svg){svg.setAttribute("width","24");svg.setAttribute("height","24");}
    }).catch(_=>{});
  }

  const $datePick=document.getElementById("datePick");
  const $btnToday=document.getElementById("btnToday");
  const $btnShare=document.getElementById("btnShare");
  const $todayCard=document.getElementById("todayCard");
  const $grid=document.getElementById("grid");
  const $moonMeta=document.getElementById("moonMeta");
  const $baseDate=document.getElementById("baseDate");
  const $baseKin=document.getElementById("baseKin");
  const $btnSaveBase=document.getElementById("btnSaveBase");
  const $btnResetBase=document.getElementById("btnResetBase");
  const $advice=document.getElementById("advice");
  const $tabCal=document.getElementById("tabCal");
  const $tabUser=document.getElementById("tabUser");
  const $pageCal=document.getElementById("page-calendar");
  const $pageUser=document.getElementById("page-user");
  const $userName=document.getElementById("userName");
  const $userBirth=document.getElementById("userBirth");
  const $btnSaveUser=document.getElementById("btnSaveUser");
  const $btnClearUser=document.getElementById("btnClearUser");
  const $userResult=document.getElementById("userResult");
  const $u_kin=document.getElementById("u_kin");
  const $u_wave=document.getElementById("u_wave");
  const $u_moon=document.getElementById("u_moon");

  function render(date){
    const base=getBase();
    $datePick.value=fmtYMD(date);
    const tm=toThirteenMoon(date);
    const k=kinOf(date, base);

    if(tm.isDOOT){
      $todayCard.innerHTML=`<div class="doot"><div class="big">ì‹œê°„ ë°–ì˜ ë‚ </div><div class="muted">7/25ì€ 13Ã—28 ìˆœí™˜ì—ì„œ ë²—ì–´ë‚œ ì‚¬ì´ ë‚ ì…ë‹ˆë‹¤.</div></div>`;
      $grid.innerHTML=""; $moonMeta.textContent=""; $advice.innerHTML="";
      return;
    }

    const g=ymd(date);
    const toneName=TONE_NAMES[k.tone-1];
    const sealName=SEAL_NAMES[k.seal-1];
    const waveName=WAVE_NAMES[k.waveIndex];
    const waveColor=WAVE_COLOR[k.waveIndex];
    const sealSlug=SEAL_SLUGS[k.seal-1];
    const sealColor=SEAL_COLOR[k.seal-1];
    const tonePath=`./src/assets/tones/${String(k.tone).padStart(2,"0")}.svg`;
    const sealPath=`./src/assets/seals/${sealSlug}.svg`;

    $todayCard.innerHTML = `
      <div class="big">${tm.month}.${tm.day} <span class="muted">(${MOON_NAMES[tm.month-1]})</span></div>
      <div class="muted" style="margin-top:4px">ê·¸ë ˆê³ ë¦¬ë ¥: ${g.y}-${fmt2(g.m)}-${fmt2(g.d)} Â· 13ë¬¸: ${tm.month}.${tm.day}</div>

      <div class="kinfo" style="margin-top:8px">
        <span class="kbadge" id="kbKin" data-tip="kin">Kin ${k.kin}</span>
        <span class="kbadge tip" data-kind="tone" data-id="${k.tone}">
          <span class="iconwrap icon-24" data-inline-svg="${tonePath}"></span> í†¤ ${toneName}
        </span>
        <span class="kbadge tip ${sealColor}" data-kind="seal" data-id="${k.seal}">
          <span class="iconwrap icon-24 ${sealColor}" data-inline-svg="${sealPath}"></span> ${sealName}
        </span>
        <span class="wavechip ${waveColor}">${waveName} ì›¨ì´ë¸ŒìŠ¤í  Â· ${k.wavePos}/13</span>
      </div>
      <div class="hint" style="margin-top:6px">(ë°°ì§€ë¥¼ íƒ­í•˜ë©´ ê°„ë‹¨ ì„¤ëª…ì´ ëœ¹ë‹ˆë‹¤)</div>
    `;

    document.querySelectorAll("[data-inline-svg]").forEach(n=> inlineSVG(n, n.getAttribute("data-inline-svg"), n.className));

    buildGrid(tm.start, tm.month, base);
    bindTips(date, base);
    $advice.innerHTML = buildAdvice(tm, k);
  }

  function buildGrid(startOfYear, monthIndex, base){
    const first = new Date(startOfYear.getTime() + (monthIndex-1)*28*86400000);
    const todayUTC=toUTC(new Date().getUTCFullYear(), new Date().getUTCMonth()+1, new Date().getUTCDate());
    let html="";
    for(let i=0;i<28;i++){
      const d=new Date(first.getTime()+i*86400000);
      const g=ymd(d);
      const tm=toThirteenMoon(d);
      const {kin}=kinOf(d, base);
      const isToday=sameUTC(d,todayUTC);
      html+=`<div class="cell ${isToday?'is-today':''}" title="Kin ${kin}"><div class="gd">${g.d}</div><div class="md">${tm.month}.${tm.day}</div></div>`;
    }
    const from=fmtYMD(first), to=fmtYMD(new Date(first.getTime()+27*86400000));
    document.getElementById("moonMeta").textContent = `${MOON_NAMES[monthIndex-1]} â€” ${from} ~ ${to}`;
    document.getElementById("grid").innerHTML = html;
  }

  function buildAdvice(tm,k){
    const toneB=TONE_BRIEF[k.tone-1]||"";
    const sealB=SEAL_BRIEF[k.seal-1]||"";
    const one = `ì˜¤ëŠ˜ì€ <b>${TONE_NAMES[k.tone-1]}</b>ì˜ ë¹›ìœ¼ë¡œ <b>${SEAL_NAMES[k.seal-1]}</b>ë¥¼ ì‚´ì•„ë‚´ëŠ” ë‚ ì…ë‹ˆë‹¤.`;
    const three = [
      `ğŸŒ™ <b>í•µì‹¬</b>: ${toneB.split("Â·")[0]}ì˜ ì˜ì‹ìœ¼ë¡œ, ${sealB.split("Â·")[0]}ì„(ë¥¼) ê¸°ì–µí•˜ì„¸ìš”.`,
      `ğŸ’­ <b>ë§ˆìŒ</b>: ${sealB}ì˜ í‚¤ì›Œë“œë¥¼ í•˜ë£¨ì˜ ì–¸ì–´/í˜¸í¡/ì‹œì„ ì— ë…¹ì—¬ë³´ì„¸ìš”.`,
      `ğŸŒ¿ <b>í–‰ë™</b>: ${TONE_NAMES[k.tone-1]}ì˜ ë¦¬ë“¬ì— ë§ì¶° í•œ ê°€ì§€ í–‰ë™ì„ ì™„ì„±í•˜ì„¸ìš”.`
    ].join("<br>");
    return `<div style="line-height:1.6">${one}<br><div class="hint" style="margin:6px 0">(${MOON_NAMES[tm.month-1]} / ì›¨ì´ë¸ŒìŠ¤í  ${k.wavePos}/13)</div>${three}</div>`;
  }

  let popEl=null;
  function closePop(){ if(popEl){ popEl.remove(); popEl=null; } }
  function showPop(target,title,body,sub=""){
    closePop();
    const el=document.createElement("div");
    el.className="pop"; el.setAttribute("data-side","top");
    el.innerHTML=`<div class="ttl">${title}</div><div>${body}</div>${sub?`<div class="sub">${sub}</div>`:""}`;
    document.body.appendChild(el);
    const r=target.getBoundingClientRect(), pad=8;
    el.style.left = (r.left)+'px'; el.style.top=(r.top-10)+'px';
    const pw=el.offsetWidth, ph=el.offsetHeight;
    const left=Math.max(8, Math.min(window.innerWidth-pw-8, r.left));
    const top=Math.max(8, r.top - ph - pad);
    el.style.left=left+'px'; el.style.top=top+'px';
    function onDoc(e){ if(!el.contains(e.target) && e.target!==target){ closePop(); document.removeEventListener('mousedown', onDoc, true);} }
    document.addEventListener('mousedown', onDoc, true);
    popEl=el;
  }
  function bindTips(date, base){
    document.querySelectorAll('.tip').forEach(btn=>{
      btn.onclick=()=>{
        const kind=btn.getAttribute('data-kind');
        const id=parseInt(btn.getAttribute('data-id'),10);
        if(kind==='tone') showPop(btn, `í†¤ ${TONE_NAMES[id-1]}`, TONE_BRIEF[id-1]||"");
        if(kind==='seal') showPop(btn, `${SEAL_NAMES[id-1]}`, SEAL_BRIEF[id-1]||"");
      };
    });
    const kb=document.getElementById("kbKin");
    if(kb){
      kb.onclick=()=>{
        const k=kinOf(date, base);
        const sub=`ì›¨ì´ë¸ŒìŠ¤í  ${k.wavePos}/13 Â· ê¸°ì¤€ ${base.baseDate} | Kin${base.baseKin}`;
        showPop(kb, `Kin ${k.kin}`, `${TONE_NAMES[k.tone-1]} Ã— ${SEAL_NAMES[k.seal-1]}`, sub);
      }
    }
  }

  const nowUTC=toUTC(new Date().getUTCFullYear(), new Date().getUTCMonth()+1, new Date().getUTCDate());
  document.getElementById("datePick").value=fmtYMD(nowUTC);
  document.getElementById("btnToday").onclick=()=>render(nowUTC);
  document.getElementById("datePick").onchange=()=>render(parseYMD(document.getElementById("datePick").value));
  document.getElementById("btnShare").onclick=async()=>{
    const text=document.querySelector("#todayCard").innerText.trim();
    if(navigator.share) await navigator.share({title:"í† íŠ¸ì˜ ë‹¬ë ¥", text});
    else { await navigator.clipboard.writeText(text); alert("ë³µì‚¬ë¨!"); }
  };

  function syncBaseInputs(){ const b=getBase(); document.getElementById("baseDate").value=b.baseDate; document.getElementById("baseKin").value=String(b.baseKin); }
  document.getElementById("btnSaveBase").onclick=()=>{
    const bd=document.getElementById("baseDate").value||DEFAULT_BASE.baseDate;
    const bk=Math.max(1,Math.min(260,parseInt(document.getElementById("baseKin").value||"34",10)));
    saveBase({baseDate:bd, baseKin:bk}); alert("ì €ì¥ë¨."); render(parseYMD(document.getElementById("datePick").value));
  };
  document.getElementById("btnResetBase").onclick=()=>{ saveBase({...DEFAULT_BASE}); syncBaseInputs(); alert("ê¸°ë³¸ê°’ìœ¼ë¡œ ì¬ì„¤ì •."); render(parseYMD(document.getElementById("datePick").value)); };

  function setTab(which){ const cal=which==='cal'; document.getElementById("page-calendar").classList.toggle("active",cal); document.getElementById("page-user").classList.toggle("active",!cal); document.getElementById("tabCal").setAttribute("aria-selected", cal?"true":"false"); document.getElementById("tabUser").setAttribute("aria-selected", !cal?"true":"false"); }
  document.getElementById("tabCal").onclick=()=>setTab('cal');
  document.getElementById("tabUser").onclick=()=>setTab('user');

  function renderUser(){
    const u=getUser();
    document.getElementById("userName").value=u.name||"";
    document.getElementById("userBirth").value=u.birth||"";
    if(u.birth){
      const base=getBase();
      const d=parseYMD(u.birth);
      const k=kinOf(d, base);
      const tm=toThirteenMoon(d);
      const tonePath=`./src/assets/tones/${String(k.tone).padStart(2,"0")}.svg`;
      const sealSlug=SEAL_SLUGS[k.seal-1];
      const sealColor=SEAL_COLOR[k.seal-1];
      const sealPath=`./src/assets/seals/${sealSlug}.svg`;
      document.getElementById("u_kin").innerHTML = `<span class="kbadge"><span class="iconwrap icon-24" data-inline-svg="${tonePath}"></span> Kin ${k.kin} â€” ${TONE_NAMES[k.tone-1]} Ã— <span class="${sealColor}">${SEAL_NAMES[k.seal-1]}</span></span>`;
      document.getElementById("u_wave").innerHTML = `${WAVE_NAMES[k.waveIndex]} ì›¨ì´ë¸ŒìŠ¤í  Â· ${k.wavePos}/13`;
      document.getElementById("u_moon").textContent = `${tm.month}.${tm.day} (${MOON_NAMES[tm.month-1]})`;
      document.getElementById("userResult").style.display="";
      document.querySelectorAll("#userResult [data-inline-svg]").forEach(n=> inlineSVG(n, n.getAttribute("data-inline-svg"), n.className));
    } else {
      document.getElementById("userResult").style.display="none";
    }
  }
  document.getElementById("btnSaveUser").onclick=()=>{ saveUser({name:document.getElementById("userName").value.trim(), birth:document.getElementById("userBirth").value}); renderUser(); alert("ì €ì¥ë¨."); };
  document.getElementById("btnClearUser").onclick=()=>{ localStorage.removeItem("user-profile"); renderUser(); };

  syncBaseInputs();
  render(nowUTC);
  renderUser();

  if('serviceWorker' in navigator){
    window.addEventListener('load', ()=>{
      navigator.serviceWorker.register('./service-worker.js').catch(()=>{});
    });
  }
})();
</script>
</body>
</html>
