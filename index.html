<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>13문 캘린더 (KO)</title>
<!-- iOS 전체화면 웹앱 -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="13문 캘린더">
<link rel="manifest" href="data:application/manifest+json,{&quot;name&quot;:&quot;13문 캘린더&quot;,&quot;short_name&quot;:&quot;13문&quot;,&quot;start_url&quot;:&quot;.&quot;,&quot;display&quot;:&quot;standalone&quot;,&quot;background_color&quot;:&quot;#0b0b0c&quot;,&quot;theme_color&quot;:&quot;#0b0b0c&quot;}" />
<style>
  :root{--bg:#0b0b0c;--fg:#e9e9ea;--muted:#9aa0a6;--card:#141518;--acc:#5dd4ff;}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, Apple SD Gothic Neo, sans-serif}
  .wrap{max-width:780px;margin:0 auto;padding:24px 16px 48px}
  h1{font-size:22px;margin:0 0 8px}
  .muted{color:var(--muted)}
  .card{background:var(--card);border:1px solid #23252a;border-radius:14px;padding:16px;margin:14px 0}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  input,button,select{border-radius:10px;border:1px solid #2a2c33;background:#1a1c21;color:var(--fg);padding:10px 12px}
  button.primary{background:#1b2a33;border-color:#24414f}
  .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:10px}
  .cell{background:#13151a;border:1px solid #262b31;border-radius:10px;padding:10px;min-height:52px;display:flex;flex-direction:column;justify-content:center;align-items:center}
  .cell .d{font-weight:700}
  .tag{display:inline-block;padding:3px 8px;border-radius:999px;border:1px solid #2a2f36;background:#111318;font-size:13px}
  .big{font-size:28px;font-weight:800;letter-spacing:0.2px}
  .kinfo{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
  .kbadge{padding:6px 10px;border-radius:9px;background:#101318;border:1px solid #28303a}
  .row > *{flex:1 1 auto}
  .split{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:720px){.split{grid-template-columns:1.2fr .8fr}}
  .hint{font-size:13px;color:var(--muted)}
  .doot{padding:16px;border:1px dashed #3a404a;border-radius:12px;background:#101216}
</style>
</head>
<body>
<div class="wrap">
  <h1>13문 캘린더 <span class="muted">— 오늘 보기 & 날짜 변환</span></h1>

  <div class="card">
    <div class="row">
      <input type="date" id="datePick" />
      <button class="primary" id="btnToday">오늘</button>
      <button id="btnShare">공유</button>
    </div>
    <div id="todayCard" style="margin-top:12px"></div>
  </div>

  <div class="split">
    <div class="card">
      <h2 style="margin-top:0">이 달(28일 그리드)</h2>
      <div id="moonMeta" class="muted" style="margin:6px 0 10px"></div>
      <div id="grid" class="grid"></div>
      <div class="hint">* 13개월 × 28일 = 364일. 7월 25일은 “시간 밖의 날(Day Out of Time)”.</div>
    </div>

    <div class="card">
      <h2 style="margin-top:0">기준 설정</h2>
      <div class="hint" style="margin-bottom:8px">
        Kin 계산 기준일과 Kin 번호는 취향/학파에 따라 다릅니다. 기본값은 <b>2025-07-26 = Kin 34</b>. 필요시 조정하세요.
      </div>
      <div class="row">
        <label style="flex:1">
          기준일(양력)
          <input type="date" id="baseDate">
        </label>
        <label style="flex:1">
          기준 Kin
          <input type="number" id="baseKin" min="1" max="260" step="1">
        </label>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="btnSaveBase" class="primary">저장</button>
        <button id="btnResetBase">기본값</button>
      </div>
    </div>
  </div>

  <div class="card">
    <h2 style="margin-top:0">설명</h2>
    <ul style="margin:8px 0 0 16px;padding:0">
      <li>13문(13개월) 날짜 표기는 <b>M.D</b> (예: <b>4.26</b> = 4번째 달 26일).</li>
      <li>Tzolkin(260일): <b>13 톤</b> × <b>20 태양문양</b> 조합으로 하루의 <b>Kin</b>이 결정됩니다.</li>
      <li>“시간 밖의 날”(7/25)은 13문 카운트에 포함되지 않습니다.</li>
    </ul>
  </div>
</div>

<script>
(function(){
  // ======= 데이터(한글 리소스) =======
  const MOON_NAMES = [
    "1 자각의 달","2 도전의 달","3 서비스의 달",
    "4 자기(형태)의 달","5 힘의 달","6 균형의 달",
    "7 공명의 달","8 무결성의 달","9 의도의 달",
    "10 현현의 달","11 해방의 달","12 협력의 달","13 우주의 달"
  ];
  const TONE_NAMES = ["1 자기","2 달","3 전기","4 자기(형태)","5 발산",
    "6 리듬","7 공명","8 은하","9 태양","10 행성","11 스펙트럴(해방)","12 수정(협력)","13 우주"];
  const SEAL_NAMES = [
    "1 붉은 용","2 흰 바람","3 파란 밤","4 노란 씨앗","5 붉은 뱀",
    "6 흰 세계연결자","7 파란 손","8 노란 별","9 붉은 달","10 흰 개",
    "11 파란 원숭이","12 노란 인간","13 붉은 하늘여행자","14 흰 마법사","15 파란 독수리",
    "16 노란 전사","17 붉은 지구","18 흰 거울","19 파란 폭풍","20 노란 태양"
  ];

  // ======= 기본 기준 (대화 합의값) =======
  const DEFAULT_BASE = { baseDate: "2025-07-26", baseKin: 34 };

  // ======= 유틸(UTC 안전) =======
  const toUTC = (y,m,d)=> new Date(Date.UTC(y,m-1,d));
  const ymd = (date)=> ({y:date.getUTCFullYear(), m:date.getUTCMonth()+1, d:date.getUTCDate()});
  const sameUTC = (a,b)=> a.getUTCFullYear()===b.getUTCFullYear() && a.getUTCMonth()===b.getUTCMonth() && a.getUTCDate()===b.getUTCDate();
  const parseYMD = (s)=>{ const [y,m,d]=s.split("-").map(Number); return toUTC(y,m,d); };
  const fmtYMD = (date)=> {
    const {y,m,d} = ymd(date);
    return [y,String(m).padStart(2,"0"),String(d).padStart(2,"0")].join("-");
  };
  const diffDaysUTC = (a,b)=> Math.floor((a - b)/86400000);

  // ======= 로컬 스토리지 =======
  const loadBase = ()=> {
    try{
      const j = JSON.parse(localStorage.getItem("kin-base")||"{}");
      if(!j.baseDate || !j.baseKin) return {...DEFAULT_BASE};
      return j;
    }catch(_){ return {...DEFAULT_BASE}; }
  };
  const saveBase = (obj)=> localStorage.setItem("kin-base", JSON.stringify(obj));

  // ======= 13문 변환 =======
  function toThirteenMoon(date){
    const {y} = ymd(date);
    const doot = toUTC(y,7,25);
    if (sameUTC(date, doot)) return { isDOOT:true };

    const startThis = toUTC(y,7,26);
    const start = (date < startThis) ? toUTC(y-1,7,26) : startThis;

    const offset = diffDaysUTC(date, start); // 0-base
    const month = Math.floor(offset/28)+1;
    const day = (offset%28)+1;
    return { isDOOT:false, month, day, start };
  }

  // ======= Kin/톤/문양 =======
  function kinOf(date, base){
    const baseDate = parseYMD(base.baseDate);
    const days = diffDaysUTC(date, baseDate);
    let kin = ((days + base.baseKin - 1) % 260 + 260) % 260 + 1;
    const tone = ((kin - 1) % 13) + 1;
    const seal = ((kin - 1) % 20) + 1;
    return { kin, tone, seal };
  }

  // ======= UI =======
  const $datePick = document.getElementById("datePick");
  const $btnToday = document.getElementById("btnToday");
  const $btnShare = document.getElementById("btnShare");
  const $todayCard = document.getElementById("todayCard");
  const $grid = document.getElementById("grid");
  const $moonMeta = document.getElementById("moonMeta");

  const $baseDate = document.getElementById("baseDate");
  const $baseKin  = document.getElementById("baseKin");
  const $btnSaveBase = document.getElementById("btnSaveBase");
  const $btnResetBase = document.getElementById("btnResetBase");

  function render(date){
    const base = loadBase();
    $datePick.value = fmtYMD(date);

    const tm = toThirteenMoon(date);
    const kin = kinOf(date, base);

    // 상단 카드
    if (tm.isDOOT){
      $todayCard.innerHTML = `
        <div class="doot">
          <div class="big">시간 밖의 날</div>
          <div class="muted">이 날은 13개월×28일 순환에 속하지 않는 ‘사이 날(7월 25일)’입니다.</div>
        </div>`;
      $moonMeta.textContent = "";
      $grid.innerHTML = "";
      return;
    }
    const moonName = MOON_NAMES[(tm.month-1)];
    const toneName = TONE_NAMES[(kin.tone-1)];
    const sealName = SEAL_NAMES[(kin.seal-1)];

    const g = ymd(date);
    const header = `
      <div class="big">${tm.month}.${tm.day} <span class="muted">(${moonName})</span></div>
      <div class="kinfo">
        <span class="kbadge">Kin ${kin.kin}</span>
        <span class="kbadge">톤 ${toneName}</span>
        <span class="kbadge">${sealName}</span>
      </div>
      <div class="muted" style="margin-top:6px">${g.y}-${String(g.m).padStart(2,"0")}-${String(g.d).padStart(2,"0")} (UTC 기준)</div>
    `;
    $todayCard.innerHTML = header;

    // 그리드: 해당 달 28칸
    buildGrid(tm.start, tm.month, base);
  }

  function buildGrid(startOfYear, monthIndex, base){
    // monthIndex: 1..13
    const first = new Date(startOfYear.getTime() + (monthIndex-1)*28*86400000);
    const cells = [];
    for(let i=0;i<28;i++){
      const d = new Date(first.getTime() + i*86400000);
      const {kin, tone, seal} = kinOf(d, base);
      const {d:dd} = ymd(d);
      cells.push({d, dd, kin, tone, seal});
    }
    $moonMeta.textContent = `${MOON_NAMES[monthIndex-1]} — ${fmtYMD(first)} ~ ${fmtYMD(new Date(first.getTime()+27*86400000))}`;

    const todayUTC = toUTC(new Date().getUTCFullYear(), new Date().getUTCMonth()+1, new Date().getUTCDate());
    $grid.innerHTML = cells.map(c=>{
      const isToday = sameUTC(c.d, todayUTC);
      return `
        <div class="cell" style="${isToday?'outline:2px solid var(--acc);':''}">
          <div class="d">${c.dd}</div>
          <div class="tag">Kin ${c.kin}</div>
        </div>`;
    }).join("");
  }

  // 초기 베이스 UI 반영
  function syncBaseInputs(){
    const base = loadBase();
    $baseDate.value = base.baseDate;
    $baseKin.value = String(base.baseKin);
  }

  // 이벤트
  $btnToday.onclick = ()=>{
    const now = toUTC(new Date().getUTCFullYear(), new Date().getUTCMonth()+1, new Date().getUTCDate());
    render(now);
  };
  $datePick.onchange = ()=>{
    render(parseYMD($datePick.value));
  };
  $btnShare.onclick = async ()=>{
    try{
      const text = document.querySelector("#todayCard").innerText.trim();
      if (navigator.share) {
        await navigator.share({text, title:"13문 캘린더"});
      } else {
        await navigator.clipboard.writeText(text);
        alert("복사됨! 원하는 곳에 붙여넣기 하세요.");
      }
    }catch(_){}
  };

  $btnSaveBase.onclick = ()=>{
    const bd = $baseDate.value;
    const bk = Math.max(1, Math.min(260, parseInt($baseKin.value||"34",10)));
    saveBase({baseDate: bd, baseKin: bk});
    alert("저장됨. 계산이 새 기준으로 반영됩니다.");
    render(parseYMD(document.getElementById("datePick").value));
  };
  $btnResetBase.onclick = ()=>{
    saveBase({...DEFAULT_BASE});
    syncBaseInputs();
    alert("기본값으로 재설정됨.");
    render(parseYMD(document.getElementById("datePick").value));
  };

  // 시작
  syncBaseInputs();
  // 첫 렌더: 오늘(UTC)
  const nowUTC = toUTC(new Date().getUTCFullYear(), new Date().getUTCMonth()+1, new Date().getUTCDate());
  document.getElementById("datePick").value = fmtYMD(nowUTC);
  render(nowUTC);
})();
</script>
</body>
</html>
