<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>í† íŠ¸ì˜ ë‹¬ë ¥ - 13 Moon Calendar (White Wizard)</title>
<link rel="manifest" href="./manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="í† íŠ¸ì˜ ë‹¬ë ¥">
<link rel="icon" href="./dreamspell_icon_512.png" sizes="512x512">
<link rel="apple-touch-icon" href="./dreamspell_icon_512.png">
<style>
:root{--bg:#0b0b0c;--fg:#e9e9ea;--muted:#9aa0a6;--card:#141518;--acc:#cfd8e3;--line:#23252a}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Apple SD Gothic Neo,sans-serif}
.wrap{max-width:880px;margin:0 auto;padding:16px 16px 96px}
h1{font-size:22px;margin:0 0 6px;font-weight:800;letter-spacing:.2px;display:flex;align-items:center;justify-content:space-between}
h2{font-size:18px;margin:0 0 10px}
.muted{color:var(--muted)}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin:12px 0}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
input,button,select{border-radius:10px;border:1px solid #2a2c33;background:#1a1c21;color:var(--fg);padding:10px 12px}
button.primary{background:#1b2a33;border-color:#24414f}
.iconbtn{background:#0f1216;border:1px solid #2a2f36;border-radius:10px;padding:8px 10px}
.grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:10px}
.cell{background:#13151a;border:1px solid #262b31;border-radius:10px;padding:8px;min-height:62px;display:flex;flex-direction:column;justify-content:center;align-items:center;position:relative}
.cell .gd{font-weight:800;font-size:16px}
.cell .md{font-size:12px;color:var(--muted)}
.is-today{border:2px solid var(--acc)!important;box-shadow:0 0 8px rgba(255,255,255,.25)}
.big{font-size:28px;font-weight:800;letter-spacing:0.2px}
.kinfo{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
.kbadge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:9px;background:#101318;border:1px solid #28303a;cursor:pointer}
.kbadge img{width:18px;height:18px;object-fit:contain}
.pill{display:inline-block;padding:4px 8px;border:1px solid #2c323a;border-radius:999px;background:#0f1216;font-size:12px;color:var(--muted)}
.pop{position:fixed;max-width:320px;background:#101318;border:1px solid #2a2f36;border-radius:10px;padding:10px 12px;box-shadow:0 6px 30px rgba(0,0,0,.35);z-index:9999;font-size:14px;line-height:1.45;backdrop-filter: blur(6px)}
.pop .ttl{font-weight:800;margin-bottom:6px}
.pop .sub{font-size:12px;color:var(--muted);margin-top:6px}
.pop::after{content:"";position:absolute;width:10px;height:10px;background:#101318;border-left:1px solid #2a2f36;border-top:1px solid #2a2f36;transform:rotate(45deg)}
.pop[data-side="top"]::after{bottom:-6px;left:16px}
.tabbar{position:fixed;left:0;right:0;bottom:0;background:#0d0e11;border-top:1px solid #1f232a;display:flex}
.tabbar button{flex:1;padding:12px 8px;background:transparent;border:0;color:var(--fg);font-weight:800}
.tabbar button[aria-selected="true"]{background:#121419}
.page{display:none}.page.active{display:block}
.badge{display:inline-block;padding:4px 8px;border:1px solid #2a2f36;border-radius:999px;background:#0f1216;font-size:12px;color:var(--muted)}
.list{display:grid;gap:10px}.item{display:flex;align-items:center;gap:12px;padding:12px;border:1px solid #2a2f36;border-radius:12px;background:#0f1116}
.item .meta{flex:1}.actions{display:flex;gap:8px}.ghost{background:transparent;border-color:#3a3f48}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:9998}
.modal .sheet{width:min(560px,92vw);background:#12141a;border:1px solid #2a2f36;border-radius:16px;padding:14px}
.close{float:right}
.titlebar{display:flex;align-items:center;justify-content:space-between}
/* Tutorial Overlay */
.tut-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:9997;display:none}
.spotlight{position:relative;z-index:9998;box-shadow:0 0 0 3px #cfd8e3, 0 0 18px rgba(255,255,255,.35)!important;border-radius:12px}
.tut-card{position:fixed;z-index:9999;max-width:360px;background:#101318;border:1px solid #2a2f36;border-radius:12px;padding:12px;box-shadow:0 10px 36px rgba(0,0,0,.4)}
.tut-card h4{margin:0 0 6px}
.tut-actions{display:flex;gap:8px;margin-top:8px;justify-content:flex-end}
.seal-img{width:24px;height:24px;object-fit:contain;vertical-align:middle}
.large-img{width:56px;height:56px;object-fit:contain;vertical-align:middle}
</style>
</head>
<body>
<div class="wrap">
  <h1><span>í† íŠ¸ì˜ ë‹¬ë ¥ <span class="muted">â€“ 13 Moon Calendar (White Wizard)</span></span></h1>

  <!-- CALENDAR -->
  <section id="page-calendar" class="page active">
    <div class="card">
      <div class="row">
        <input type="date" id="datePick"/>
        <button class="primary" id="btnToday">ì˜¤ëŠ˜</button>
        <button id="btnShare">ê³µìœ </button>
      </div>
      <div id="todayCard" style="margin-top:10px"></div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <h2>ì´ ë‹¬(28ì¼ ê·¸ë¦¬ë“œ)</h2>
        <div class="row">
          <span id="legend" class="pill">ì…€=ì–‘ë ¥ / í•˜ë‹¨=13ë¬¸ M.D</span>
          <button id="btnFindDate" class="iconbtn">íŠ¹ì • ë‚ ì§œ ê²€ìƒ‰</button>
          <button id="btnRefresh" class="iconbtn" style="display:none">â†»</button>
        </div>
      </div>
      <div id="moonMeta" class="muted" style="margin:6px 0 10px"></div>
      <div id="grid" class="grid"></div>
      <div class="muted" style="margin-top:8px">* 13Ã—28=364. 7/25ëŠ” "ì‹œê°„ ë°–ì˜ ë‚ ".</div>
    </div>

    <div class="card">
      <h2>ê¸°ì¤€ & ì˜¤ëŠ˜ì˜ ì œì•ˆ</h2>
      <div class="row">
        <label style="flex:1">ê¸°ì¤€ì¼ <input type="date" id="baseDate"></label>
        <label style="flex:1">ê¸°ì¤€ Kin <input type="number" id="baseKin" min="1" max="260"></label>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="btnSaveBase" class="primary">ì €ì¥</button>
        <button id="btnResetBase">ê¸°ë³¸ê°’</button>
      </div>
      <div class="card" style="margin-top:12px">
        <h3 style="margin:0 0 6px">ì˜¤ëŠ˜ì˜ ì œì•ˆ</h3>
        <div id="advice"></div>
      </div>
    </div>
  </section>

  <!-- GUIDE -->
  <section id="page-guide" class="page">
    <h2 style="margin:0 0 8px">13Moon ê°€ì´ë“œ ğŸŒ™</h2>
    <div class="card"><h3 style="margin:0 0 6px">13Moon ë‹¬ë ¥ì´ë€?</h3><div class="muted">ë‹¬ì˜ ë¦¬ë“¬ì„ ë”°ë¥´ëŠ” ë‹¬ë ¥ (28ì¼ Ã— 13ë‹¬ = 364ì¼) + "ì‹œê°„ ë°–ì˜ ë‚ (7/25)"</div></div>
    <div class="card"><h3 style="margin:0 0 6px">í•µì‹¬ êµ¬ì„±ìš”ì†Œ ğŸ§±</h3>
      <ul style="margin:0;padding-left:18px;line-height:1.7">
        <li><b>íƒœì–‘ ì¸ì¥(20)</b> â€” ë¹¨ê°•/ë…¸ë‘/íŒŒë‘/í•˜ì–‘ Ã— 5ê°œì”©: ê¸°ì§ˆ(ì˜ˆ: íŒŒë€ ë°¤=ê¿ˆÂ·í’ìš”)</li>
        <li><b>í†¤(1~13)</b> â€” ì—ë„ˆì§€ì˜ ë¦¬ë“¬/ê°•ë„ (1=ì‹œì‘, 13=ì™„ì„±)</li>
        <li><b>KIN</b> â€” ì¸ì¥+í†¤ ì¡°í•©(20Ã—13=260): ìš°ì£¼ ID</li>
        <li><b>ì›¨ì´ë¸ŒìŠ¤í </b> â€” 13ì¼ íë¦„(í†¤ì´ 1â†’13ìœ¼ë¡œ ì§„í–‰)</li>
      </ul>
    </div>
    <div class="card"><h3 style="margin:0 0 6px">ì˜ˆì‹œ â€” ì˜¤ëŠ˜ ì½ê¸°</h3>
      <div>"13 íŒŒë€ ë°¤"ì´ë¼ë©´ â†’ <b>ì™„ì„±/ì´ˆì›”</b>ì˜ ì‹œì„ ìœ¼ë¡œ <b>ê¿ˆê³¼ ì ì¬ì˜ í’ìš”</b>ë¥¼ í˜„ì‹¤ì— ë“œëŸ¬ë‚´ëŠ” ë‚ .</div>
      <div class="muted" style="margin-top:6px">ì›¨ì´ë¸ŒìŠ¤í  13ì¼ì°¨: ì‘ì€ ì‹¤ì²œ í•˜ë‚˜ê°€ ì „ì²´ë¥¼ ì™„ì„±ìœ¼ë¡œ ì´ë•ë‹ˆë‹¤.</div>
    </div>
    <div class="card"><h3 style="margin:0 0 6px">í™œìš©ë²• ğŸ’«</h3>
      <ul style="margin:0;padding-left:18px;line-height:1.7">
        <li>ì˜¤ëŠ˜ì˜ ì—ë„ˆì§€ ë‚ ì”¨ í™•ì¸ â†’ í•˜ë£¨ ê³„íš</li>
        <li>ì¤‘ìš”í•œ ë‚  ë¯¸ë¦¬ ì²´í¬, íšŒì˜/ì°½ì‘ íƒ€ì´ë° ì¡°ì ˆ</li>
        <li>ë‚˜ì™€ ì˜ ë§ëŠ” ì‚¬ëŒì˜ Kin íŒŒì•…</li>
      </ul>
    </div>
  </section>

  <!-- PROFILES -->
  <section id="page-profiles" class="page">
    <div class="titlebar">
      <h2 style="margin:0">ì€í•˜ í”„ë¡œí•„</h2>
      <div class="row">
        <button id="btnCompat" class="iconbtn">â¤ ê¶í•©</button>
        <button id="btnAddProfile" class="iconbtn">ï¼‹</button>
      </div>
    </div>
    <div class="card" style="margin-top:10px">
      <div class="list" id="profileList"></div>
      <div class="muted" style="margin-top:6px">ì—¬ëŸ¬ ì‚¬ëŒì˜ ìƒì¼ì„ ì €ì¥í•´ ë‘ê³  Kin/ì›¨ì´ë¸ŒìŠ¤í /í•´ì„/ê¶í•©ì„ ë¹ ë¥´ê²Œ ë³´ì„¸ìš”.</div>
    </div>
  </section>
</div>

<nav class="tabbar">
  <button id="tabCal" aria-selected="true">ìº˜ë¦°ë”</button>
  <button id="tabGuide" aria-selected="false">ê°€ì´ë“œ</button>
  <button id="tabProfiles" aria-selected="false">ì€í•˜ í”„ë¡œí•„</button>
</nav>

<!-- Modals -->
<div id="modal" class="modal">
  <div class="sheet">
    <button id="mClose" class="iconbtn close">ë‹«ê¸°</button>
    <h3 style="margin-top:0">ì€í•˜ í”„ë¡œí•„ ì¶”ê°€</h3>
    <div class="row">
      <label style="flex:1">ì´ë¦„(ì„ íƒ)<input type="text" id="mName" placeholder="ì´ë¦„ ë˜ëŠ” ë³„ëª…"></label>
      <label style="flex:1">ìƒì¼(ì–‘ë ¥)<input type="date" id="mBirth"></label>
    </div>
    <div class="row" style="margin-top:8px">
      <label style="flex:1">ì¶œìƒì‹œê°„(ì„ íƒ)<input type="time" id="mTime"></label>
      <div style="flex:1"></div>
    </div>
    <div class="row" style="margin-top:12px"><button id="mSave" class="primary">ì €ì¥</button></div>
  </div>
</div>

<div id="modalFind" class="modal">
  <div class="sheet">
    <button id="fClose" class="iconbtn close">ë‹«ê¸°</button>
    <h3 style="margin:0 0 8px">íŠ¹ì • ë‚ ì§œ ê²€ìƒ‰</h3>
    <div class="row"><input type="date" id="findDate" style="flex:1"><button id="fGo" class="primary">ì´ë™</button></div>
    <div class="muted" style="margin-top:6px">í•´ë‹¹ ë‚ ì§œì˜ 13ë¬¸ ë‹¬ë¡œ ì´ë™í•˜ê³  ê·¸ë¦¬ë“œì—ì„œ ê°•ì¡° í‘œì‹œí•©ë‹ˆë‹¤.</div>
  </div>
</div>

<div id="modalCompat" class="modal">
  <div class="sheet">
    <button id="cClose" class="iconbtn close">ë‹«ê¸°</button>
    <h3 style="margin:0 0 8px">ë‘ ì‚¬ëŒ ê¶í•© ë³´ê¸°</h3>
    <div class="row">
      <label style="flex:1">ì‚¬ëŒ A<select id="selA"></select></label>
      <label style="flex:1">ì‚¬ëŒ B<select id="selB"></select></label>
    </div>
    <div class="row" style="margin-top:10px"><button id="cRun" class="primary">ê¶í•© ë³´ê¸°</button></div>
    <div id="compatResult" style="margin-top:10px"></div>
  </div>
</div>

<!-- Tutorial -->
<div id="tutOverlay" class="tut-overlay"></div>
<div id="tutCard" class="tut-card" style="display:none">
  <h4 id="tutTitle">íŠœí† ë¦¬ì–¼</h4>
  <div id="tutBody" class="muted">ì„¤ëª…</div>
  <div class="tut-actions">
    <button id="tutSkip" class="iconbtn">ë‹¤ì‹œ ë³´ì§€ ì•Šê¸°</button>
    <button id="tutNext" class="primary">ë‹¤ìŒ</button>
  </div>
</div>

<script>
(function(){
  // ---------- ì•ˆì „í•œ localStorage ë˜í¼ ----------
  const safeStorage = (() => {
    try{
      const t='__test__';
      window.localStorage.setItem(t,'1');
      window.localStorage.removeItem(t);
      return window.localStorage;
    }catch(e){
      // ì¹´ì¹´ì˜¤ ì¸ì•± ë¸Œë¼ìš°ì € ë“±ì—ì„œ ë§‰íŒ ê²½ìš°
      return {
        getItem: () => null,
        setItem: () => {},
        removeItem: () => {}
      };
    }
  })();

  // ---------- ì—ì…‹ ê²½ë¡œ ----------
  const ASSET_BASE = "./src/assets";
  const sealImg = (seal) => `${ASSET_BASE}/seals/${String(seal).padStart(2,'0')}.svg`;
  const toneImg = (tone) => `${ASSET_BASE}/tones/${String(tone).padStart(2,'0')}.svg`;
  const moonImg = (m)    => `${ASSET_BASE}/moons/${String(m).padStart(2,'0')}.svg`;
  const imgTag = (src, cls="seal-img", alt="") =>
    `<img src="${src}" class="${cls}" alt="${alt}" onerror="this.style.display='none'">`;

  // ---------- ìƒìˆ˜ ----------
  const MOON_NAMES = ["1 ìê°ì˜ ë‹¬","2 ë„ì „ì˜ ë‹¬","3 ì„œë¹„ìŠ¤ì˜ ë‹¬","4 ìê¸°(í˜•íƒœ)ì˜ ë‹¬","5 í˜ì˜ ë‹¬","6 ê· í˜•ì˜ ë‹¬","7 ê³µëª…ì˜ ë‹¬","8 ë¬´ê²°ì„±ì˜ ë‹¬","9 ì˜ë„ì˜ ë‹¬","10 í˜„í˜„ì˜ ë‹¬","11 í•´ë°©ì˜ ë‹¬","12 í˜‘ë ¥ì˜ ë‹¬","13 ìš°ì£¼ì˜ ë‹¬"];
  const TONE_NAMES = ["1 ìê¸°","2 ë‹¬","3 ì „ê¸°","4 ìê¸°(í˜•íƒœ)","5 ë°œì‚°","6 ë¦¬ë“¬","7 ê³µëª…","8 ì€í•˜","9 íƒœì–‘","10 í–‰ì„±","11 ìŠ¤í™íŠ¸ëŸ´(í•´ë°©)","12 ìˆ˜ì •(í˜‘ë ¥)","13 ìš°ì£¼"];
  const SEAL_NAMES = ["1 ë¶‰ì€ ìš©","2 í° ë°”ëŒ","3 íŒŒë€ ë°¤","4 ë…¸ë€ ì”¨ì•—","5 ë¶‰ì€ ë±€","6 í° ì„¸ê³„ì—°ê²°ì","7 íŒŒë€ ì†","8 ë…¸ë€ ë³„","9 ë¶‰ì€ ë‹¬","10 í° ê°œ","11 íŒŒë€ ì›ìˆ­ì´","12 ë…¸ë€ ì¸ê°„","13 ë¶‰ì€ í•˜ëŠ˜ì—¬í–‰ì","14 í° ë§ˆë²•ì‚¬","15 íŒŒë€ ë…ìˆ˜ë¦¬","16 ë…¸ë€ ì „ì‚¬","17 ë¶‰ì€ ì§€êµ¬","18 í° ê±°ìš¸","19 íŒŒë€ í­í’","20 ë…¸ë€ íƒœì–‘"];
  const TONE_BRIEF = ["ëª©ì Â·ì˜ì§€Â·í˜„ì¡´","ë„ì „Â·ê·¹ì„±Â·ê· í˜•","ë´‰ì‚¬Â·í™œì„±Â·ì˜ë„","í˜•íƒœÂ·ì •ì˜Â·í˜•ìƒí™”","í˜Â·ë³µì œÂ·ë°©ì‚¬","íë¦„Â·ê· í˜•Â·ì¡°ìœ¨","ê³µëª…Â·ì±„ë„ë§Â·ì¡°ìœ¨","ëª¨ë¸Â·ë¬´ê²°ì„±Â·ì¡°í™”","ì‹¤í˜„Â·ì˜ë„Â·ë¹›","í˜„í˜„Â·ì™„ì„±Â·ìƒì‚°","í•´ë°©Â·ìš©í•´Â·í•´ì²´","í˜‘ë ¥Â·ì¡°í•©Â·í—Œì‹ ","ìš°ì£¼Â·ì¡´ì¬Â·ì´ˆì›”"];
  const SEAL_BRIEF = ["íƒ„ìƒÂ·ì–‘ìœ¡Â·ê¸°ì´ˆ","ì†Œí†µÂ·í˜¸í¡Â·ì˜ê°","ê¿ˆÂ·í’ìš”Â·ì ì¬ì˜ì‹","ì”¨ì•—Â·ë°œì•„Â·ì ì¬ë ¥","ìƒëª…ë ¥Â·ë³¸ëŠ¥Â·ì •í™”","ë†“ì•„ë³´ëƒ„Â·ì£½ìŒÂ·ê¸°íšŒ","ì¹˜ìœ Â·ì™„ì„±Â·ì§€ì‹","ì•„ë¦„ë‹¤ì›€Â·ì˜ˆìˆ Â·ì¡°í™”","ì •í™”Â·íë¦„Â·ë¬¼","ì‚¬ë‘Â·ì¶©ì„±Â·ë§ˆìŒ","ìœ í¬Â·ë§ˆë²•Â·ì¬ì¹˜","ììœ ì˜ì§€Â·ì§€í˜œÂ·ì˜í–¥","íƒí—˜Â·ê³µê°„Â·ê°ì„±","ì£¼ìˆ Â·ì‹œê°„Â·ìˆ˜ìš©","ë¹„ì „Â·ì°½ê³µÂ·ë§ˆìŒì˜ ëˆˆ","ì§ˆë¬¸Â·ì§€ì„±Â·ëŒ€ë‹´","ë™ê¸°í™”Â·í•­ë²•Â·ì§€êµ¬","ë°˜ì˜Â·ì§ˆì„œÂ·ê²½ê³„","ë³€í˜•Â·ì´‰ë§¤Â·ì—ë„ˆì§€","ê³„ëª½Â·ìƒëª…Â·ë³´í¸ì  ë¶ˆ"];

  const DEFAULT_BASE = { baseDate: "2025-07-26", baseKin: 34 };

  const toUTC=(y,m,d)=>new Date(Date.UTC(y,m-1,d));
  const ymd=(d)=>({y:d.getUTCFullYear(),m:d.getUTCMonth()+1,d:d.getUTCDate()});
  const parseYMD=(s)=>{const [y,m,d]=s.split("-").map(Number);return toUTC(y,m,d)};
  const fmt2=(n)=>String(n).padStart(2,"0");
  const fmtYMD=(d)=>{const o=ymd(d);return [o.y,fmt2(o.m),fmt2(o.d)].join("-")};
  const sameUTC=(a,b)=>a.getUTCFullYear()===b.getUTCFullYear()&&a.getUTCMonth()===b.getUTCMonth()&&a.getUTCDate()===b.getUTCDate();
  const diffDaysUTC=(a,b)=>Math.floor((a-b)/86400000);

  const getBase=()=>{try{const j=JSON.parse(safeStorage.getItem("kin-base")||"{}");return (j.baseDate&&j.baseKin)?j:DEFAULT_BASE}catch(e){return DEFAULT_BASE}};
  const saveBase=(b)=>safeStorage.setItem("kin-base", JSON.stringify(b));

  function toThirteenMoon(date){
    const {y}=ymd(date);
    const doot=toUTC(y,7,25);
    if(sameUTC(date,doot)) return {isDOOT:true};
    const startThis=toUTC(y,7,26);
    const start=(date<startThis)?toUTC(y-1,7,26):startThis;
    const offset=diffDaysUTC(date,start);
    return {isDOOT:false, month:Math.floor(offset/28)+1, day:(offset%28)+1, start};
  }

  function kinOf(date, base){
    const baseDate=parseYMD(base.baseDate);
    const days=diffDaysUTC(date, baseDate);
    const kin=((days+base.baseKin-1)%260+260)%260+1;
    const tone=((kin-1)%13)+1;
    const seal=((kin-1)%20)+1;
    const waveIndex=Math.floor((kin-1)/13);
    const wavePos=((kin-1)%13)+1;
    return {kin,tone,seal,waveIndex,wavePos};
  }

  // ë”°ëœ»í•œ ë‚´ë ˆì´ì…˜
  const TONE_VOICE={1:"ì˜¤ëŠ˜ì€ ìƒˆë¡œìš´ ì”¨ì•—ì„ ì‹¬ëŠ” ë‚ . ê°€ìŠ´ ê¹Šì´ í’ˆì€ ì˜ë„ í•˜ë‚˜ë¥¼ ìš°ì£¼ì— ì„ ì–¸í•´ë³´ì„¸ìš”",2:"ë¹›ê³¼ ê·¸ë¦¼ìê°€ ì¶¤ì¶”ëŠ” ë‚ . ì–‘ê·¹ì˜ ê· í˜• ì†ì—ì„œ ë‹¹ì‹ ë§Œì˜ ë¦¬ë“¬ì„ ì°¾ì•„ë³´ì„¸ìš”",3:"ë‹¹ì‹ ì˜ ì—ë„ˆì§€ê°€ ëˆ„êµ°ê°€ì—ê²Œ ë¹›ì´ ë˜ëŠ” ë‚ . ì‘ì€ ë´‰ì‚¬ê°€ í° ìš¸ë¦¼ì„ ë§Œë“¤ì–´ëƒ…ë‹ˆë‹¤",4:"í©ì–´ì§„ ì¡°ê°ë“¤ì´ í˜•íƒœë¥¼ ê°–ì¶”ëŠ” ë‚ . ì°¨ê·¼ì°¨ê·¼ ê¸°ì´ˆë¥¼ ë‹¤ì§€ë©´ íŠ¼íŠ¼í•œ ì„±ì´ ë©ë‹ˆë‹¤",5:"ë‚´ë©´ì˜ ë¶ˆê½ƒì´ íƒ€ì˜¤ë¥´ëŠ” ë‚ . ë‹¹ì‹ ì˜ ì—´ì •ì„ ì„¸ìƒê³¼ ë‚˜ëˆ„ì„¸ìš”",6:"ìˆ¨ê²°ì²˜ëŸ¼ ìì—°ìŠ¤ëŸ¬ìš´ ë¦¬ë“¬ì˜ ë‚ . ë“¤ìˆ¨ê³¼ ë‚ ìˆ¨ ì‚¬ì´ì—ì„œ ê· í˜•ì„ ì°¾ì•„ë³´ì„¸ìš”",7:"ë§ˆìŒì˜ í˜„ì´ ìš¸ë¦¬ëŠ” ë‚ . ì§ê´€ì˜ ëª©ì†Œë¦¬ì— ê·€ ê¸°ìš¸ì—¬ë³´ì„¸ìš”",8:"ë§ê³¼ í–‰ë™ì´ í•˜ë‚˜ê°€ ë˜ëŠ” ë‚ . ì§„ì •ì„±ì´ ë‹¹ì‹ ì˜ ê°€ì¥ í° í˜ì…ë‹ˆë‹¤",9:"ê¿ˆì´ í˜„ì‹¤ë¡œ í”¼ì–´ë‚˜ëŠ” ë‚ . í•œ ê±¸ìŒë§Œ ë” ë‚˜ì•„ê°€ë©´ ë³„ì— ë‹¿ì„ ìˆ˜ ìˆì–´ìš”",10:"ì—´ë§¤ê°€ ë§ºíˆëŠ” ê°ì‚¬ì˜ ë‚ . ê·¸ë™ì•ˆì˜ ì—¬ì •ì„ ì¶•í•˜í•˜ë©° ê²°ì‹¤ì„ ê±°ë‘¬ë³´ì„¸ìš”",11:"ë‚¡ì€ ê»ì§ˆì„ ë²—ëŠ” ë‚ . ë†“ì•„ì£¼ë©´ ìƒˆë¡œìš´ ê³µê°„ì´ ì—´ë¦½ë‹ˆë‹¤",12:"í•¨ê»˜í•˜ë©´ ë” ì•„ë¦„ë‹¤ìš´ ë‚ . í˜‘ë ¥ì˜ ë§ˆë²•ì´ ê¸°ì ì„ ë§Œë“¤ì–´ëƒ…ë‹ˆë‹¤",13:"ëª¨ë“  ê²ƒì´ í•˜ë‚˜ë¡œ ì—°ê²°ë˜ëŠ” ë‚ . í° ê·¸ë¦¼ì„ ë³´ë©° ì¡°ìš©íˆ ë¯¸ì†Œ ì§€ì–´ë³´ì„¸ìš”"};
  const SEAL_VOICE={1:"ìƒëª…ì˜ ì²« ìˆ¨ê²°ì²˜ëŸ¼, ìƒˆë¡œìš´ ì‹œì‘ì„ í’ˆì–´ë³´ì„¸ìš”. ë‹¹ì‹ ì€ ì°½ì¡°ì˜ ë¶ˆê½ƒì…ë‹ˆë‹¤",2:"ë°”ëŒì²˜ëŸ¼ ììœ ë¡­ê²Œ ì†Œí†µí•˜ì„¸ìš”. ë‹¹ì‹ ì˜ ë§ì—ëŠ” ì˜í˜¼ì„ ê¹¨ìš°ëŠ” í˜ì´ ìˆìŠµë‹ˆë‹¤",3:"ë°¤í•˜ëŠ˜ì˜ ë³„ì²˜ëŸ¼ ê¿ˆì„ í’ˆì–´ë³´ì„¸ìš”. ë‚´ë©´ì˜ í’ìš”ê°€ í˜„ì‹¤ë¡œ í˜ëŸ¬ë‚˜ì˜µë‹ˆë‹¤",4:"ì‘ì€ ì”¨ì•—ì´ ê±°ëŒ€í•œ ë‚˜ë¬´ê°€ ë˜ë“¯, ê°€ëŠ¥ì„±ì„ ë¯¿ê³  ê¸°ë‹¤ë ¤ë³´ì„¸ìš”",5:"ìƒëª…ì˜ ì¶¤ì„ ì¶”ì„¸ìš”. ëª¸ì˜ ì§€í˜œê°€ ê¸¸ì„ ì•Œë ¤ì¤„ ê±°ì˜ˆìš”",6:"ë‹¤ë¦¬ê°€ ë˜ì–´ ì—°ê²°í•˜ì„¸ìš”. ë†“ì•„ì¤Œì´ ë•Œë¡œëŠ” ê°€ì¥ í° ì„ ë¬¼ì…ë‹ˆë‹¤",7:"ì¹˜ìœ ì˜ ì†ê¸¸ë¡œ ì„¸ìƒì„ ì–´ë£¨ë§Œì§€ì„¸ìš”. ë‹¹ì‹ ì˜ ë”°ëœ»í•¨ì´ ê¸°ì ì„ ë§Œë“­ë‹ˆë‹¤",8:"ì•„ë¦„ë‹¤ì›€ì˜ ëˆˆìœ¼ë¡œ ì„¸ìƒì„ ë³´ì„¸ìš”. ì¡°í™”ë¡œìš´ ë¹›ì´ ë‹¹ì‹ ì„ í†µí•´ ë¹›ë‚©ë‹ˆë‹¤",9:"ê°ì •ì˜ ê°•ë¬¼ì²˜ëŸ¼ í˜ëŸ¬ê°€ì„¸ìš”. ì •í™”ì˜ ë¬¼ê²°ì´ ëª¨ë“  ê²ƒì„ ìƒˆë¡­ê²Œ í•©ë‹ˆë‹¤",10:"ì¶©ì‹¤í•œ ë§ˆìŒìœ¼ë¡œ ì‚¬ë‘í•˜ì„¸ìš”. ì§„ì •í•œ ìš°ì •ì´ ì‚¶ì„ í’ìš”ë¡­ê²Œ í•©ë‹ˆë‹¤",11:"ë†€ì´í•˜ëŠ” ë§ˆìŒìœ¼ë¡œ ì‚´ì•„ë³´ì„¸ìš”. ì›ƒìŒ ì†ì— ì§€í˜œê°€ ìˆ¨ì–´ìˆìŠµë‹ˆë‹¤",12:"ììœ ë¡œìš´ ì˜í˜¼ìœ¼ë¡œ ì„ íƒí•˜ì„¸ìš”. ë‹¹ì‹ ì˜ ì˜ì§€ê°€ ì„¸ìƒì„ ë³€í™”ì‹œí‚µë‹ˆë‹¤",13:"ë¯¸ì§€ì˜ ì„¸ê³„ë¡œ ëª¨í—˜ì„ ë– ë‚˜ì„¸ìš”. ìƒˆë¡œìš´ ì°¨ì›ì´ ë‹¹ì‹ ì„ ê¸°ë‹¤ë¦½ë‹ˆë‹¤",14:"ì‹œê°„ì˜ ë§ˆë²•ì‚¬ê°€ ë˜ì–´ë³´ì„¸ìš”. ì§€ê¸ˆ ì´ ìˆœê°„ì´ ì˜ì›ì…ë‹ˆë‹¤",15:"ë…ìˆ˜ë¦¬ì˜ ëˆˆìœ¼ë¡œ ë©€ë¦¬ ë³´ì„¸ìš”. ë†’ì€ ì‹œì•¼ê°€ ì§„ì‹¤ì„ ë³´ì—¬ì¤ë‹ˆë‹¤",16:"ìš©ê¸° ìˆëŠ” ì§ˆë¬¸ìœ¼ë¡œ ê¸¸ì„ ì—¬ì„¸ìš”. ë‘ë ¤ì›€ ë„ˆë¨¸ì— ììœ ê°€ ìˆìŠµë‹ˆë‹¤",17:"ì§€êµ¬ì˜ ë§¥ë°•ê³¼ í•¨ê»˜ í˜¸í¡í•˜ì„¸ìš”. í° ë¦¬ë“¬ ì†ì—ì„œ ì¶¤ì¶”ê³  ìˆìŠµë‹ˆë‹¤",18:"ê±°ìš¸ì²˜ëŸ¼ ë§‘ê²Œ ë¹„ì¶°ë³´ì„¸ìš”. ì§„ì‹¤ì´ ëª¨ë“  ê²ƒì„ ì •í™”í•©ë‹ˆë‹¤",19:"ë³€í™”ì˜ í­í’ì„ íƒ€ê³  ë‚ ì•„ë³´ì„¸ìš”. í˜¼ëˆ ì†ì—ì„œ ìƒˆë¡œìš´ ì§ˆì„œê°€ íƒœì–´ë‚©ë‹ˆë‹¤",20:"íƒœì–‘ì²˜ëŸ¼ ë¹›ë‚˜ì„¸ìš”. ë‹¹ì‹ ì˜ ì¡´ì¬ ìì²´ê°€ ì¶•ë³µì…ë‹ˆë‹¤"};

  // Tooltip
  let popEl=null;
  function closePop(){ if(popEl){ popEl.remove(); popEl=null; } }
  function showPop(target,title,body,sub=""){
    closePop();
    const el=document.createElement("div");
    el.className="pop"; el.setAttribute("data-side","top");
    el.innerHTML=`<div class="ttl">${title}</div><div>${body}</div>${sub?`<div class="sub">${sub}</div>`:""}`;
    document.body.appendChild(el);
    const r=target.getBoundingClientRect(), pad=8;
    const pw=el.offsetWidth, ph=el.offsetHeight;
    const left=Math.max(8, Math.min(window.innerWidth-pw-8, r.left));
    const top=Math.max(8, r.top - ph - pad);
    el.style.left=left+'px'; el.style.top=top+'px';
    function onDoc(e){ if(!el.contains(e.target) && e.target!==target){ closePop(); document.removeEventListener('mousedown', onDoc, true);} }
    document.addEventListener('mousedown', onDoc, true);
    popEl=el;
  }

  // Calendar/UI references
  const $datePick=document.getElementById("datePick");
  const $btnToday=document.getElementById("btnToday");
  const $btnShare=document.getElementById("btnShare");
  const $todayCard=document.getElementById("todayCard");
  const $grid=document.getElementById("grid");
  const $moonMeta=document.getElementById("moonMeta");
  const $baseDate=document.getElementById("baseDate");
  const $baseKin=document.getElementById("baseKin");
  const $btnSaveBase=document.getElementById("btnSaveBase");
  const $btnResetBase=document.getElementById("btnResetBase");
  const $advice=document.getElementById("advice");
  const $btnFindDate=document.getElementById("btnFindDate");
  const $btnRefresh=document.getElementById("btnRefresh");

  let isSearchMode=false;

  function buildAdvice(tm,k){
    const one = `ì˜¤ëŠ˜ì€ <b>${TONE_NAMES[k.tone-1]}</b>ì˜ ë¹›ìœ¼ë¡œ <b>${SEAL_NAMES[k.seal-1]}</b>ë¥¼ ì‚´ì•„ë‚´ëŠ” ë‚ ì…ë‹ˆë‹¤.`;
    const three = [
      `ğŸŒ™ <b>í•µì‹¬</b>: ${TONE_BRIEF[k.tone-1].split("Â·")[0]}ì˜ ì˜ì‹ìœ¼ë¡œ, ${SEAL_BRIEF[k.seal-1].split("Â·")[0]}ì„(ë¥¼) ê¸°ì–µí•˜ì„¸ìš”.`,
      `ğŸ’­ <b>ë§ˆìŒ</b>: ${SEAL_BRIEF[k.seal-1]}ì˜ í‚¤ì›Œë“œë¥¼ í˜¸í¡ê³¼ ì–¸ì–´ì— ë‹´ì•„ë³´ì„¸ìš”.`,
      `ğŸŒ¿ <b>í–‰ë™</b>: ${TONE_NAMES[k.tone-1]}ì˜ ë¦¬ë“¬ìœ¼ë¡œ ì‘ì€ ê¸°ì ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”.`
    ].join("<br>");
    return `<div style="line-height:1.6">${one}<br><div class="muted" style="margin:6px 0">(${MOON_NAMES[tm.month-1]})</div>${three}</div>`;
  }

  function buildGrid(startOfYear, monthIndex, base, highlightDate){
    const first = new Date(startOfYear.getTime() + (monthIndex-1)*28*86400000);
    const today = new Date();
    const todayUTC = toUTC(today.getUTCFullYear(), today.getUTCMonth()+1, today.getUTCDate());
    let html="";
    for(let i=0;i<28;i++){
      const d=new Date(first.getTime()+i*86400000);
      const g=ymd(d);
      const tm=toThirteenMoon(d);
      const isTarget = highlightDate ? sameUTC(d, highlightDate) : false;
      const isToday = sameUTC(d, todayUTC);
      const cls = (isTarget || isToday) ? "cell is-today" : "cell";
      html+=`<div class="${cls}"><div class="gd">${g.d}</div><div class="md">${tm.month}.${tm.day}</div></div>`;
    }
    const from=fmtYMD(first);
    const last = new Date(first.getTime()+27*86400000);
    const to=fmtYMD(last);
    $moonMeta.textContent = `${MOON_NAMES[monthIndex-1]} â€” ${from} ~ ${to}`;
    $grid.innerHTML = html;
  }

  function render(date, opts={}){
    const base=getBase();
    $datePick.value=fmtYMD(date);
    const tm=toThirteenMoon(date);
    if(tm.isDOOT){ $todayCard.innerHTML='<div class="card">ì‹œê°„ ë°–ì˜ ë‚ </div>'; $grid.innerHTML=""; return; }
    const k=kinOf(date, base);
    const g=ymd(date);
    const toneIcon = imgTag(toneImg(k.tone));
    const sealIcon = imgTag(sealImg(k.seal));
    const moonIcon = imgTag(moonImg(tm.month));
    const toneBadge = `<span class="kbadge tip" data-kind="tone" data-id="${k.tone}">${toneIcon} í†¤ ${TONE_NAMES[k.tone-1]}</span>`;
    const sealBadge = `<span class="kbadge tip" data-kind="seal" data-id="${k.seal}">${sealIcon} ${SEAL_NAMES[k.seal-1]}</span>`;
    const waveNames=["ë¶‰ì€ ìš©","í° ë°”ëŒ","íŒŒë€ ë°¤","ë…¸ë€ ì”¨ì•—","ë¶‰ì€ ë±€","í° ì„¸ê³„ì—°ê²°ì","íŒŒë€ ì†","ë…¸ë€ ë³„","ë¶‰ì€ ë‹¬","í° ê°œ","íŒŒë€ ì›ìˆ­ì´","ë…¸ë€ ì¸ê°„","ë¶‰ì€ í•˜ëŠ˜ì—¬í–‰ì","í° ë§ˆë²•ì‚¬","íŒŒë€ ë…ìˆ˜ë¦¬","ë…¸ë€ ì „ì‚¬","ë¶‰ì€ ì§€êµ¬","í° ê±°ìš¸","íŒŒë€ í­í’","ë…¸ë€ íƒœì–‘"];

    $todayCard.innerHTML = `
      <div class="big">${moonIcon} ${tm.month}.${tm.day} <span class="muted">(${MOON_NAMES[tm.month-1]})</span></div>
      <div class="muted" style="margin-top:4px">ê·¸ë ˆê³ ë¦¬ë ¥: ${g.y}-${fmt2(g.m)}-${fmt2(g.d)} Â· 13ë¬¸: ${tm.month}.${tm.day}</div>
      <div class="kinfo" style="margin-top:8px">
        <span class="kbadge" id="kbKin">${sealIcon} Kin ${k.kin}</span>
        ${toneBadge}
        ${sealBadge}
        <span class="badge">${waveNames[k.waveIndex]} ì›¨ì´ë¸ŒìŠ¤í  Â· ${k.wavePos}/13</span>
      </div>
      <div class="muted" style="margin-top:6px">(ë°°ì§€ë¥¼ íƒ­í•˜ë©´ ê°„ë‹¨ ì„¤ëª…)</div>
    `;

    buildGrid(tm.start, tm.month, base, opts.highlightDate || date);
    bindTips(date);
    $advice.innerHTML = buildAdvice(tm, k);

    if(opts.highlightDate){
      isSearchMode = true;
      $btnRefresh.style.display='inline-block';
    }
  }

  function bindTips(date){
    const kb=document.getElementById("kbKin");
    if(kb){
      kb.onclick=()=>{ const k=kinOf(date, getBase()); showPop(kb, `Kin ${k.kin}`, `${TONE_NAMES[k.tone-1]} Ã— ${SEAL_NAMES[k.seal-1]}`); };
    }
    document.querySelectorAll('.tip').forEach(el=>{
      el.onclick=()=>{
        const kind=el.getAttribute('data-kind'); const id=parseInt(el.getAttribute('data-id'),10);
        if(kind==='tone'){ showPop(el, `í†¤ ${TONE_NAMES[id-1]}`, `<img src="${toneImg(id)}" class="large-img" alt=""><div style="margin-top:6px">${TONE_BRIEF[id-1]||""}</div>`); }
        if(kind==='seal'){ showPop(el, `${SEAL_NAMES[id-1]}`, `<img src="${sealImg(id)}" class="large-img" alt=""><div style="margin-top:6px">${SEAL_BRIEF[id-1]||""}</div>`); }
      };
    });
  }

  // Tabs
  const $tabCal=document.getElementById("tabCal");
  const $tabGuide=document.getElementById("tabGuide");
  const $tabProfiles=document.getElementById("tabProfiles");
  const $pageCal=document.getElementById("page-calendar");
  const $pageGuide=document.getElementById("page-guide");
  const $pageProfiles=document.getElementById("page-profiles");

  function setTab(which){
    const isCal = which==='cal', isGuide=which==='guide', isPro=which==='profiles';
    $pageCal.classList.toggle("active", isCal);
    $pageGuide.classList.toggle("active", isGuide);
    $pageProfiles.classList.toggle("active", isPro);
    $tabCal.setAttribute("aria-selected", isCal?"true":"false");
    $tabGuide.setAttribute("aria-selected", isGuide?"true":"false");
    $tabProfiles.setAttribute("aria-selected", isPro?"true":"false");
  }
  $tabCal.onclick=()=>setTab('cal');
  $tabGuide.onclick=()=>setTab('guide');
  $tabProfiles.onclick=()=>setTab('profiles');

  // Profiles store
  const LS_KEY="galacticProfiles";
  const getProfiles=()=>{ try{ return JSON.parse(safeStorage.getItem(LS_KEY)||"[]"); }catch(e){ return [];} };
  const saveProfiles=(arr)=>safeStorage.setItem(LS_KEY, JSON.stringify(arr));

  function addProfile(name,birth,time){
    if(!birth) return;
    const base=getBase();
    const d=parseYMD(birth);
    const k=kinOf(d, base);
    const tm=toThirteenMoon(d);
    const p={ id:Date.now(), name:name||"", birth, time:time||"", kin:k.kin, tone:k.tone, seal:k.seal, waveIndex:k.waveIndex, wavePos:k.wavePos, moon:tm.month, moonDay:tm.day };
    const arr=getProfiles(); arr.push(p); saveProfiles(arr); renderProfileList();
  }
  function deleteProfile(id){ const arr=getProfiles().filter(p=>p.id!==id); saveProfiles(arr); renderProfileList(); }

  function interpretCard(p){
    const waveNames=["ë¶‰ì€ ìš©","í° ë°”ëŒ","íŒŒë€ ë°¤","ë…¸ë€ ì”¨ì•—","ë¶‰ì€ ë±€","í° ì„¸ê³„ì—°ê²°ì","íŒŒë€ ì†","ë…¸ë€ ë³„","ë¶‰ì€ ë‹¬","í° ê°œ","íŒŒë€ ì›ìˆ­ì´","ë…¸ë€ ì¸ê°„","ë¶‰ì€ í•˜ëŠ˜ì—¬í–‰ì","í° ë§ˆë²•ì‚¬","íŒŒë€ ë…ìˆ˜ë¦¬","ë…¸ë€ ì „ì‚¬","ë¶‰ì€ ì§€êµ¬","í° ê±°ìš¸","íŒŒë€ í­í’","ë…¸ë€ íƒœì–‘"];
    const toneName=TONE_NAMES[p.tone-1], sealName=SEAL_NAMES[p.seal-1], waveName=waveNames[p.waveIndex];
    const intro = `ë‹¹ì‹ ì€ <b>${toneName}</b>ì˜ ë¹›ìœ¼ë¡œ <b>${sealName}</b>ì˜ ì§€í˜œë¥¼ ë‚˜ëˆ„ëŠ” ì¡´ì¬ì…ë‹ˆë‹¤.`;
    const body = `<p style="margin:8px 0">${TONE_VOICE[p.tone]}</p><p style="margin:8px 0">${SEAL_VOICE[p.seal]}</p>`;
    let special = "";
    if(p.tone===13 && p.seal===16){
      special = `<p style="margin:8px 0;font-style:italic">âœ¨ ìš°ì£¼ ë…¸ë€ ì „ì‚¬ëŠ” ê°€ì¥ ë†’ì€ ì°¨ì›ì˜ ì˜ì  ì „ì‚¬ì…ë‹ˆë‹¤. ë‘ë ¤ì›€ì„ ì´ˆì›”í•œ ì§ˆë¬¸ìœ¼ë¡œ ì§„ì‹¤ì˜ ë¬¸ì„ ì—´ê³ , ì§€í˜œì™€ ìš©ê¸°ë¡œ ë‹¤ë¥¸ ì´ë“¤ì„ ì´ë•ë‹ˆë‹¤.</p>`;
    } else if(p.tone===12 && p.seal===3){
      special = `<p style="margin:8px 0;font-style:italic">ğŸŒ™ ìˆ˜ì • íŒŒë€ ë°¤ì€ ê¿ˆì˜ í˜‘ë ¥ìì…ë‹ˆë‹¤. ì§‘ë‹¨ ë¬´ì˜ì‹ì˜ ë³´ë¬¼ì„ í˜„ì‹¤ë¡œ ëŒì–´ë‚´ì–´ ëª¨ë‘ì™€ ë‚˜ëˆ•ë‹ˆë‹¤.</p>`;
    }
    return `
      <div class="card">
        <h3 style="margin:0 0 8px">ì€í•˜ ì„œëª…: KIN ${p.kin}</h3>
        <div style="font-size:18px;font-weight:600;margin-bottom:8px">
          ${imgTag(sealImg(p.seal))} ${toneName} Ã— ${sealName}
        </div>
        <div class="muted" style="margin-bottom:10px;line-height:1.6">
          â€¢ í†¤ ì—ë„ˆì§€: ${TONE_BRIEF[p.tone-1]}<br>
          â€¢ ì¸ì¥ íŠ¹ì„±: ${SEAL_BRIEF[p.seal-1]}<br>
          â€¢ ì›¨ì´ë¸ŒìŠ¤í : ${waveName} (${p.wavePos}/13)<br>
          â€¢ íƒ„ìƒ 13ë¬¸: ${p.moon}.${p.moonDay} (${MOON_NAMES[p.moon-1]})
        </div>
        <div style="line-height:1.7;color:#cfd8e3">
          <p style="margin:8px 0">${intro}</p>
          ${body}
          ${special}
          <p style="margin:12px 0 0;font-size:14px;color:#9aa0a6">
            ğŸ’« ì˜¤ëŠ˜ì˜ ì‘ì€ ì‹¤ì²œ: ${
              p.tone===13 ? "ì™„ì„±ì˜ ì—ë„ˆì§€ë¡œ ë¯¸ì™„ì„±ëœ ì¼ í•˜ë‚˜ë¥¼ ë§ˆë¬´ë¦¬í•´ë³´ì„¸ìš”" :
              p.tone===1  ? "ìƒˆë¡œìš´ ì˜ë„ë¥¼ ë…¸íŠ¸ì— ì ì–´ë³´ì„¸ìš”" :
              p.tone===7  ? "ëª…ìƒì´ë‚˜ ì‚°ì±…ìœ¼ë¡œ ë‚´ë©´ì˜ ì†Œë¦¬ë¥¼ ë“¤ì–´ë³´ì„¸ìš”" :
                            "ì˜¤ëŠ˜ì˜ ì—ë„ˆì§€ì™€ í•¨ê»˜ ìˆ¨ ì‰¬ë©° ìì—°ìŠ¤ëŸ½ê²Œ í˜ëŸ¬ê°€ì„¸ìš”"}
          </p>
        </div>
      </div>`;
  }

  function renderProfileList(){
    const list=document.getElementById("profileList");
    const arr=getProfiles();
    if(!arr.length){ list.innerHTML='<div class="muted">ì•„ì§ ì €ì¥ëœ í”„ë¡œí•„ì´ ì—†ìŠµë‹ˆë‹¤. ìš°ì¸¡ ìƒë‹¨ ï¼‹ ë²„íŠ¼ìœ¼ë¡œ ì¶”ê°€í•˜ì„¸ìš”.</div>'; return; }
    const waveNames=["ë¶‰ì€ ìš©","í° ë°”ëŒ","íŒŒë€ ë°¤","ë…¸ë€ ì”¨ì•—","ë¶‰ì€ ë±€","í° ì„¸ê³„ì—°ê²°ì","íŒŒë€ ì†","ë…¸ë€ ë³„","ë¶‰ì€ ë‹¬","í° ê°œ","íŒŒë€ ì›ìˆ­ì´","ë…¸ë€ ì¸ê°„","ë¶‰ì€ í•˜ëŠ˜ì—¬í–‰ì","í° ë§ˆë²•ì‚¬","íŒŒë€ ë…ìˆ˜ë¦¬","ë…¸ë€ ì „ì‚¬","ë¶‰ì€ ì§€êµ¬","í° ê±°ìš¸","íŒŒë€ í­í’","ë…¸ë€ íƒœì–‘"];
    arr.sort((a,b)=> (a.name||"").localeCompare(b.name||""));
    list.innerHTML = arr.map(p=>`
      <div class="item">
        <img src="${ASSET_BASE}/icon_person_info.png" width="36" height="36" alt="person" onerror="this.style.display='none'">
        <div class="meta">
          <div style="font-weight:800">${p.name||'ì´ë¦„ ì—†ìŒ'}</div>
          <div class="muted" style="font-size:13px">
            ${p.birth} Â· Kin ${p.kin} â€” ${TONE_NAMES[p.tone-1]} Ã— ${SEAL_NAMES[p.seal-1]} Â· ${waveNames[p.waveIndex]} ${p.wavePos}/13
          </div>
        </div>
        <div class="actions">
          <button class="ghost" data-act="view" data-id="${p.id}">ë“œë¦¼ìŠ¤í  í•´ì„</button>
          <button class="ghost" data-act="del" data-id="${p.id}">ì‚­ì œ</button>
        </div>
      </div>
    `).join("");

    list.querySelectorAll("button").forEach(btn=>{
      const id=parseInt(btn.getAttribute("data-id"),10);
      const act=btn.getAttribute("data-act");
      btn.onclick=()=>{
        const p=getProfiles().find(x=>x.id===id); if(!p) return;
        if(act==="del"){ if(confirm("ì‚­ì œí• ê¹Œìš”?")) deleteProfile(id); }
        if(act==="view"){
          const host=document.createElement('div');
          host.className='modal'; host.style.display='flex';
          host.innerHTML=`<div class="sheet"><button class="iconbtn close" id="ivClose">ë‹«ê¸°</button>${interpretCard(p)}</div>`;
          document.body.appendChild(host);
          host.querySelector('#ivClose').onclick=()=>host.remove();
          host.onclick=(e)=>{ if(e.target===host) host.remove(); };
        }
      };
    });
  }

  // Modals
  const $modal=document.getElementById("modal");
  document.getElementById("btnAddProfile").onclick=()=>{ $modal.style.display='flex'; };
  document.getElementById("mClose").onclick=()=>{ $modal.style.display='none'; };
  $modal.onclick=(e)=>{ if(e.target===$modal) $modal.style.display='none'; };
  document.getElementById("mSave").onclick=()=>{
    const name=document.getElementById("mName").value.trim();
    const birth=document.getElementById("mBirth").value;
    const time=document.getElementById("mTime").value;
    if(!birth){ alert("ìƒì¼ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”"); return; }
    addProfile(name,birth,time);
    document.getElementById("mName").value="";
    document.getElementById("mBirth").value="";
    document.getElementById("mTime").value="";
    $modal.style.display='none';
  };

  // Find date modal
  const $modalFind=document.getElementById("modalFind");
  document.getElementById("btnFindDate").onclick=()=>{$modalFind.style.display='flex';};
  document.getElementById("fClose").onclick=()=>{$modalFind.style.display='none';};
  $modalFind.onclick=(e)=>{ if(e.target===$modalFind) $modalFind.style.display='none'; };
  document.getElementById("fGo").onclick=()=>{
    const v=document.getElementById("findDate").value;
    if(!v){alert("ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”");return;}
    const d=parseYMD(v);
    render(d,{highlightDate:d});
    $modalFind.style.display='none';
    setTab('cal');
  };

  // ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ - ì˜¤ëŠ˜ë¡œ
  $btnRefresh.onclick=()=>{
    isSearchMode=false;
    $btnRefresh.style.display='none';
    const now=new Date();
    const nowUTC=toUTC(now.getUTCFullYear(), now.getUTCMonth()+1, now.getUTCDate());
    render(nowUTC);
  };

  // ê¶í•©
  const $modalCompat=document.getElementById("modalCompat");
  const $selA=document.getElementById("selA");
  const $selB=document.getElementById("selB");
  const $compatResult=document.getElementById("compatResult");

  document.getElementById("btnCompat").onclick=()=>{
    populateSelects();
    $modalCompat.style.display='flex';
  };
  document.getElementById("cClose").onclick=()=>{$modalCompat.style.display='none';};
  $modalCompat.onclick=(e)=>{ if(e.target===$modalCompat) $modalCompat.style.display='none'; };

  function populateSelects(){
    const arr=getProfiles();
    if(!arr.length){
      $selA.innerHTML="";
      $selB.innerHTML="";
      $compatResult.innerHTML='<div class="muted">ë¨¼ì € í”„ë¡œí•„ì„ í•˜ë‚˜ ì´ìƒ ì¶”ê°€í•´ ì£¼ì„¸ìš”.</div>';
      return;
    }
    const opts = arr.map(p=>`<option value="${p.id}">${p.name||'(ì´ë¦„ ì—†ìŒ)'} â€” Kin ${p.kin}</option>`).join("");
    $selA.innerHTML=opts;
    $selB.innerHTML=opts;
  }

  function toneRelation(a,b){
    if(a===b) return "ê°™ì€ ë¦¬ë“¬ì„ íƒ€ê³  ìˆì–´ìš”. ì„œë¡œì˜ í˜ì´ìŠ¤ë¥¼ ìì—°ìŠ¤ëŸ½ê²Œ ì´í•´í•©ë‹ˆë‹¤ ğŸ’«";
    const diff=((b-a)%13+13)%13;
    if(diff===6||diff===7) return "ì™„ë²½í•œ ê· í˜•ì„ ì´ë£¨ëŠ” ì‚¬ì´ì˜ˆìš”. ì„œë¡œì˜ ë¹ˆ ê³³ì„ ë”°ëœ»í•˜ê²Œ ì±„ì›Œì¤ë‹ˆë‹¤ âš–ï¸";
    if(diff===1||diff===12) return "í•œ ë°œì§ ì°¨ì´ì˜ ì•„ë¦„ë‹¤ì›€. í•œ ì‚¬ëŒì´ ì‹œì‘í•˜ë©´ ë‹¤ë¥¸ ì‚¬ëŒì´ ì™„ì„±ì„ ë„ì™€ìš” ğŸ¤";
    return "ë‹¤ë¥¸ í…œí¬ì˜ í•˜ëª¨ë‹ˆ. ê°ìì˜ ì—­í• ì´ ëª…í™•í•  ë•Œ ì‹œë„ˆì§€ê°€ í­ë°œí•´ìš” ğŸµ";
  }
  function sealRelation(a,b){
    if(a===b) return "ì˜í˜¼ì˜ ìŒë‘¥ì´ì²˜ëŸ¼ ê¹Šì€ ì´í•´ì™€ ê³µê°ì´ íë¦…ë‹ˆë‹¤ ğŸ‘«";
    const colors = ["red","white","blue","yellow"];
    const ca=colors[(a-1)%4], cb=colors[(b-1)%4];
    if(ca===cb) return "ê°™ì€ ìƒ‰ì˜ ì—ë„ˆì§€ë¡œ í¸ì•ˆí•˜ê³  ìì—°ìŠ¤ëŸ¬ìš´ ìœ ëŒ€ê°ì„ ë‚˜ëˆ•ë‹ˆë‹¤ ğŸ¨";
    if((ca==="red"&&cb==="white")||(ca==="white"&&cb==="red")) return "ì—´ì •ê³¼ ì •í™”ì˜ ë§Œë‚¨. ì„œë¡œë¥¼ ì„±ì¥ì‹œí‚¤ëŠ” ê±°ìš¸ì´ ë©ë‹ˆë‹¤ ğŸ”¥â„ï¸";
    if((ca==="blue"&&cb==="yellow")||(ca==="yellow"&&cb==="blue")) return "ë³€í™”ì™€ ì„±ìˆ™ì˜ ì¡°í™”. í•¨ê»˜í•˜ë©´ ë¬´í•œí•œ ê°€ëŠ¥ì„±ì´ ì—´ë¦½ë‹ˆë‹¤ ğŸ’™ğŸ’›";
    return "ë‹¤ì±„ë¡œìš´ ìƒ‰ì˜ ë§Œë‚¨. ì„œë¡œì˜ ë‹¤ë¦„ì´ ì•„ë¦„ë‹¤ìš´ ë¬´ì§€ê°œë¥¼ ë§Œë“­ë‹ˆë‹¤ ğŸŒˆ";
  }
  function compatAdvice(a,b){
    const tips=[
      "ğŸŒ™ ë§¤ë‹¬ ë³´ë¦„ë‹¬ì— í•¨ê»˜ ì‚°ì±…í•˜ë©° ì„œë¡œì˜ ê¿ˆì„ ë‚˜ëˆ„ì–´ë³´ì„¸ìš”.",
      "ğŸ“ 'ê°ì‚¬ êµí™˜ ì¼ê¸°'ë¥¼ ì¨ë³´ì„¸ìš”. ì„œë¡œì—ê²Œ ê³ ë§ˆìš´ ì  3ê°€ì§€ë¥¼ ë§¤ì£¼ ë‚˜ëˆ„ë©´ ê´€ê³„ê°€ ë”ìš± ë”°ëœ»í•´ì§‘ë‹ˆë‹¤.",
      "ğŸ¯ 13ì¼ë§ˆë‹¤ ì‘ì€ í”„ë¡œì íŠ¸ë¥¼ í•¨ê»˜ í•´ë³´ì„¸ìš”. ìš”ë¦¬, ê·¸ë¦¼, ì •ì› ê°€ê¾¸ê¸°... ë¬´ì—‡ì´ë“  ì¢‹ì•„ìš”!",
      "â˜• 'ì—ë„ˆì§€ íƒ€ì„'ì„ ì •í•´ë³´ì„¸ìš”. ê°ìê°€ ê°€ì¥ ë¹›ë‚˜ëŠ” ì‹œê°„ì„ ì¡´ì¤‘í•˜ë©° ê·¸ ì‹œê°„ì—” ì„œë¡œë¥¼ ì‘ì›í•´ì£¼ì„¸ìš”.",
      "ğŸŒ± í•¨ê»˜ ì‹ë¬¼ì„ í‚¤ì›Œë³´ì„¸ìš”. ë§¤ì¼ ë¬¼ì„ ì£¼ë©° ì„œë¡œì˜ ì„±ì¥ë„ í•¨ê»˜ ëŒë´ì£¼ëŠ” ì˜ë¯¸ê°€ ë©ë‹ˆë‹¤.",
      "âœ¨ ì›” 1íšŒ 'ì„œí”„ë¼ì´ì¦ˆ ë°ì´'ë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”. ì‘ì€ ì„ ë¬¼ì´ë‚˜ í¸ì§€ë¡œ ì¼ìƒì— ë§ˆë²•ì„ ë”í•´ìš”."
    ];
    return tips[(a.kin+b.kin)%tips.length];
  }

  function runCompat(){
    const arr=getProfiles(); if(!arr.length){ alert("ë¨¼ì € í”„ë¡œí•„ì„ í•˜ë‚˜ ì´ìƒ ì¶”ê°€í•´ ì£¼ì„¸ìš”."); return; }
    const A=arr.find(p=>p.id===Number($selA.value));
    const B=arr.find(p=>p.id===Number($selB.value));
    if(!A||!B){ alert("ë‘ ì‚¬ëŒì„ ì„ íƒí•˜ì„¸ìš”."); return; }
    const tRel=toneRelation(A.tone,B.tone);
    const sRel=sealRelation(A.seal,B.seal);
    const advice=compatAdvice(A,B);
    let specialMsg = "";
    if(A.kin===B.kin){
      specialMsg = `<p style="margin:8px 0;color:#f0c674">â­ ê°™ì€ KIN! ìš´ëª…ì ì¸ ë§Œë‚¨ì…ë‹ˆë‹¤. ì„œë¡œë¥¼ ê¹Šì´ ì´í•´í•˜ëŠ” ì˜í˜¼ì˜ ë™ë°˜ìì˜ˆìš”.</p>`;
    } else if(Math.abs(A.kin-B.kin)===130){
      specialMsg = `<p style="margin:8px 0;color:#f0c674">ğŸŒŸ ìˆ¨ê²¨ì§„ ì¡°í™”ì˜ íŒŒíŠ¸ë„ˆ! ì •ë°˜ëŒ€ì²˜ëŸ¼ ë³´ì´ì§€ë§Œ ì™„ë²½í•œ ê· í˜•ì„ ì´ë£¹ë‹ˆë‹¤.</p>`;
    }
    $compatResult.innerHTML = `
      <div class="card" style="line-height:1.7">
        <h3 style="margin:0 0 10px">ğŸ’• ê¶í•© ê²°ê³¼</h3>
        <div class="muted" style="margin-bottom:10px;font-size:14px">
          <b>${A.name||'A'}</b> Â· Kin ${A.kin} (${TONE_NAMES[A.tone-1]} Ã— ${SEAL_NAMES[A.seal-1]})<br>
          <b>${B.name||'B'}</b> Â· Kin ${B.kin} (${TONE_NAMES[B.tone-1]} Ã— ${SEAL_NAMES[B.seal-1]})
        </div>
        ${specialMsg}
        <p style="margin:10px 0"><b>ë¦¬ë“¬ì˜ ì¡°í™”</b><br>${tRel}</p>
        <p style="margin:10px 0"><b>ì—ë„ˆì§€ì˜ ë§Œë‚¨</b><br>${sRel}</p>
        <div style="margin-top:12px;padding:12px;background:#1a1c21;border-radius:8px">
          <div style="font-weight:600;margin-bottom:6px">ğŸ’« íŠ¹ë³„ ì œì•ˆ</div>
          <div style="font-size:14px;color:#cfd8e3">${advice}</div>
        </div>
      </div>`;
  }
  document.getElementById("cRun").onclick=runCompat;

  // Tutorial
  const tutOverlay=document.getElementById("tutOverlay");
  const tutCard=document.getElementById("tutCard");
  const tutTitle=document.getElementById("tutTitle");
  const tutBody=document.getElementById("tutBody");
  const tutSkip=document.getElementById("tutSkip");
  const tutNext=document.getElementById("tutNext");
  const TUT_KEY_SEEN="tutV1Seen";
  const TUT_KEY_NEVER="tutV1Never";
  const steps=[
    {sel:"#todayCard", title:"ì˜¤ëŠ˜ ì¹´ë“œ", body:"ì˜¤ëŠ˜ì˜ Kin, í†¤/ì¸ì¥, ì›¨ì´ë¸ŒìŠ¤í ê³¼ ì œì•ˆì„ í•œëˆˆì— ë´…ë‹ˆë‹¤."},
    {sel:"#grid", title:"28ì¼ ê·¸ë¦¬ë“œ", body:"ì…€ì€ ì–‘ë ¥, í•˜ë‹¨ì€ 13ë¬¸ ë‚ ì§œì…ë‹ˆë‹¤. 'íŠ¹ì • ë‚ ì§œ ê²€ìƒ‰'ìœ¼ë¡œ ë°”ë¡œ ì´ë™í•  ìˆ˜ ìˆì–´ìš”."},
    {sel:"#tabProfiles", title:"ì€í•˜ í”„ë¡œí•„", body:"ë³¸ì¸/ì§€ì¸ì„ ì¶”ê°€í•˜ê³  í•´ì„ê³¼ ë‘ ì‚¬ëŒ ê¶í•©ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.", beforeShow:()=>setTab('profiles')},
    {sel:"#tabGuide", title:"ê°€ì´ë“œ", body:"13Moon ê¸°ë³¸ ê°œë…ê³¼ í™œìš©ë²•ì„ ê°„ë‹¨íˆ ì •ë¦¬í–ˆìŠµë‹ˆë‹¤.", beforeShow:()=>setTab('guide')}
  ];
  let stepIdx=0, spotlightEl=null;
  function clearSpot(){ if(spotlightEl){ spotlightEl.classList.remove('spotlight'); spotlightEl=null; } }
  function positionTutCard(target){
    const r=target.getBoundingClientRect();
    const cardWidth=360, cardHeight=140;
    let x=r.left + (r.width/2) - (cardWidth/2);
    let y=r.bottom + 12;
    x=Math.max(12, Math.min(window.innerWidth-cardWidth-12, x));
    if(y+cardHeight>window.innerHeight-12) y=r.top-cardHeight-12;
    tutCard.style.left=x+"px"; tutCard.style.top=y+"px";
  }
  function runStep(idx){
    clearSpot();
    const s=steps[idx];
    if(s.beforeShow) s.beforeShow();
    setTimeout(()=>{
      const el=document.querySelector(s.sel);
      if(!el){ endTut(); return; }
      tutTitle.textContent=s.title; tutBody.textContent=s.body;
      tutOverlay.style.display='block';
      tutCard.style.display='block';
      el.classList.add('spotlight'); spotlightEl=el;
      el.scrollIntoView({behavior:'smooth',block:'center'});
      setTimeout(()=>positionTutCard(el),300);
    },100);
  }
  function endTut(){
    clearSpot(); tutOverlay.style.display='none'; tutCard.style.display='none';
    safeStorage.setItem(TUT_KEY_SEEN,"1");
    setTab('cal');
  }
  tutNext.onclick=()=>{ stepIdx++; if(stepIdx>=steps.length){ endTut(); } else { runStep(stepIdx);} };
  tutSkip.onclick=()=>{ safeStorage.setItem(TUT_KEY_NEVER,"1"); endTut(); };
  function maybeStartTutorial(){
    const never=safeStorage.getItem(TUT_KEY_NEVER)==="1";
    const seen=safeStorage.getItem(TUT_KEY_SEEN)==="1";
    if(!never && !seen){ stepIdx=0; runStep(0); }
  }

  // Init
  const now=new Date();
  const nowUTC=toUTC(now.getUTCFullYear(), now.getUTCMonth()+1, now.getUTCDate());
  function syncBaseInputs(){ const b=getBase(); $baseDate.value=b.baseDate; $baseKin.value=String(b.baseKin); }
  $btnSaveBase.onclick=()=>{
    const bd=$baseDate.value||DEFAULT_BASE.baseDate;
    const bk=Math.max(1,Math.min(260,parseInt($baseKin.value||"34",10)));
    saveBase({baseDate:bd, baseKin:bk}); alert("ì €ì¥ë¨."); render(nowUTC);
  };
  $btnResetBase.onclick=()=>{ saveBase({...DEFAULT_BASE}); syncBaseInputs(); alert("ê¸°ë³¸ê°’ìœ¼ë¡œ ì¬ì„¤ì •."); render(nowUTC); };
  $datePick.value=fmtYMD(nowUTC);
  $btnToday.onclick=()=>render(nowUTC);
  $datePick.onchange=()=>render(parseYMD($datePick.value));
  $btnShare.onclick=async()=>{
    const text=document.querySelector("#todayCard").innerText.trim();
    if(navigator.share){ try{ await navigator.share({title:"í† íŠ¸ì˜ ë‹¬ë ¥", text}); }catch(e){} }
    else{ try{ await navigator.clipboard.writeText(text); alert("ë³µì‚¬ë¨!"); }catch(e){} }
  };

  syncBaseInputs();
  render(nowUTC);
  renderProfileList();
  maybeStartTutorial();

  if('serviceWorker' in navigator){
    window.addEventListener('load', ()=>{
      navigator.serviceWorker.register('./service-worker.js').catch(()=>{});
    });
  }
})();
</script>
</body>
</html>