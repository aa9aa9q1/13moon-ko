<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>13문 캘린더 (KO)</title>

<!-- iOS 전체화면 웹앱 -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="13문 캘린더">

<!-- PWA manifest(간단 버전) -->
<link rel="manifest" href='data:application/manifest+json,{"name":"13문 캘린더","short_name":"13문","start_url":".","display":"standalone","background_color":"#0b0b0c","theme_color":"#0b0b0c"}' />

<!-- 자동색상 팔레트 & 아이콘 크기 유틸 -->
<link rel="stylesheet" href="./src/assets/dreamspell.css" />

<style>
  :root{--bg:#0b0b0c;--fg:#e9e9ea;--muted:#9aa0a6;--card:#141518;--acc:#5dd4ff;}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Apple SD Gothic Neo,sans-serif}
  .wrap{max-width:780px;margin:0 auto;padding:24px 16px 72px}
  h1{font-size:22px;margin:0 0 8px}
  h2{font-size:18px;margin:0 0 10px}
  .muted{color:var(--muted)}
  .card{background:var(--card);border:1px solid #23252a;border-radius:14px;padding:16px;margin:14px 0}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  input,button{border-radius:10px;border:1px solid #2a2c33;background:#1a1c21;color:var(--fg);padding:10px 12px}
  button.primary{background:#1b2a33;border-color:#24414f}
  .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:10px}
  .cell{background:#13151a;border:1px solid #262b31;border-radius:10px;padding:10px;min-height:52px;display:flex;flex-direction:column;justify-content:center;align-items:center}
  .cell .d{font-weight:700}
  .big{font-size:28px;font-weight:800;letter-spacing:0.2px}
  .kinfo{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
  .kbadge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:9px;background:#101318;border:1px solid #28303a;cursor:pointer}
  .row > *{flex:1 1 auto}
  .split{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:720px){.split{grid-template-columns:1.2fr .8fr}}
  .hint{font-size:13px;color:var(--muted)}
  .doot{padding:16px;border:1px dashed #3a404a;border-radius:12px;background:#101216}
  .iconwrap{display:inline-flex;align-items:center;justify-content:center}
  /* 툴팁(꼬리표) */
  .pop {
    position: fixed; max-width: 260px;
    background:#101318; border:1px solid #2a2f36;
    border-radius:10px; padding:10px 12px;
    box-shadow:0 6px 30px rgba(0,0,0,.35); z-index:9999;
    font-size:14px; line-height:1.45;
  }
  .pop .ttl {font-weight:700; margin-bottom:4px}
  .pop::after {
    content:""; position:absolute; width:10px; height:10px;
    background:#101318; border-left:1px solid #2a2f36; border-top:1px solid #2a2f36;
    transform:rotate(45deg);
  }
  .pop[data-side="top"]::after { bottom:-6px; left:16px; }
  /* 오늘 테두리 */
  .is-today{outline:2px solid var(--acc);}
</style>
</head>
<body>
<div class="wrap">
  <h1>13문 캘린더 <span class="muted">— 오늘 보기 & 날짜 변환</span></h1>

  <!-- 상단: 날짜 선택/오늘/공유 + 오늘 카드 -->
  <div class="card">
    <div class="row">
      <input type="date" id="datePick" />
      <button class="primary" id="btnToday">오늘</button>
      <button id="btnShare">공유</button>
    </div>
    <div id="todayCard" style="margin-top:12px"></div>
  </div>

  <!-- 좌: 28일 그리드 / 우: 기준 설정 -->
  <div class="split">
    <div class="card">
      <h2>이 달(28일 그리드)</h2>
      <div id="moonMeta" class="muted" style="margin:6px 0 10px"></div>
      <div id="grid" class="grid"></div>
      <div class="hint" style="margin-top:8px">* 13개월 × 28일 = 364일. 7월 25일은 “시간 밖의 날(Day Out of Time)”.</div>
    </div>

    <div class="card">
      <h2>기준 설정</h2>
      <div class="hint" style="margin-bottom:8px">
        Kin 계산 기준일과 Kin 번호는 취향/학파에 따라 다릅니다. 기본값은 <b>2025-07-26 = Kin 34</b>. 필요시 조정하세요.
      </div>
      <div class="row">
        <label style="flex:1">
          기준일(양력)
          <input type="date" id="baseDate">
        </label>
        <label style="flex:1">
          기준 Kin
          <input type="number" id="baseKin" min="1" max="260" step="1">
        </label>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="btnSaveBase" class="primary">저장</button>
        <button id="btnResetBase">기본값</button>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>설명</h2>
    <ul style="margin:8px 0 0 16px;padding:0">
      <li>13문(13개월) 날짜 표기는 <b>M.D</b> (예: <b>4.26</b> = 4번째 달 26일).</li>
      <li>Tzolkin(260일): <b>13 톤</b> × <b>20 태양문양</b> 조합으로 하루의 <b>Kin</b>이 결정됩니다.</li>
      <li>“시간 밖의 날”(7/25)은 13문 카운트에 포함되지 않습니다.</li>
    </ul>
  </div>
</div>

<script>
(function(){
  // ======= 한글 리소스 =======
  const MOON_NAMES = [
    "1 자각의 달","2 도전의 달","3 서비스의 달",
    "4 자기(형태)의 달","5 힘의 달","6 균형의 달",
    "7 공명의 달","8 무결성의 달","9 의도의 달",
    "10 현현의 달","11 해방의 달","12 협력의 달","13 우주의 달"
  ];
  const TONE_NAMES = ["1 자기","2 달","3 전기","4 자기(형태)","5 발산",
    "6 리듬","7 공명","8 은하","9 태양","10 행성","11 스펙트럴(해방)","12 수정(협력)","13 우주"];
  const SEAL_NAMES = [
    "1 붉은 용","2 흰 바람","3 파란 밤","4 노란 씨앗","5 붉은 뱀","6 흰 세계연결자",
    "7 파란 손","8 노란 별","9 붉은 달","10 흰 개","11 파란 원숭이","12 노란 인간",
    "13 붉은 하늘여행자","14 흰 마법사","15 파란 독수리","16 노란 전사","17 붉은 지구",
    "18 흰 거울","19 파란 폭풍","20 노란 태양"
  ];

  // 꼬리표 요약
  const TONE_BRIEF = [
    "목적·의지·현존","도전·극성·균형","봉사·활성·의도","형태·정의·형상화","힘·복제·방사",
    "흐름·균형·조율","공명·조율·채널링","모델·무결성·조화","실현·의도·빛","현현·완성·생산",
    "해방·용해·해체","협력·조합·헌신","우주·존재·초월"
  ];
  const SEAL_BRIEF = [
    "탄생·양육·기초","소통·호흡·영감","꿈·풍요·잠재의식","씨앗·발아·잠재력","생명력·본능·정화",
    "죽음·놓아보냄·기회","치유·완성·지식","아름다움·예술·조화","정화·흐름·물","사랑·충성·마음",
    "놀이·유희·마법","자유의지·지혜·영향","탐험·공간·각성","주술·시간·수용","비전·창공·마음의 눈",
    "질문·지성·대담","항법·동기화·지구","반영·질서·끝과 시작","변형·촉매·에너지","계몽·생명·보편적 불"
  ];

  // 각 문양의 파일슬러그 & 색상 클래스(자동색상)
  const SEAL_SLUGS = [
    "01_red-dragon","02_white-wind","03_blue-night","04_yellow-seed","05_red-serpent",
    "06_white-worldbridger","07_blue-hand","08_yellow-star","09_red-moon","10_white-dog",
    "11_blue-monkey","12_yellow-human","13_red-skywalker","14_white-wizard","15_blue-eagle",
    "16_yellow-warrior","17_red-earth","18_white-mirror","19_blue-storm","20_yellow-sun"
  ];
  const SEAL_COLOR = [
    "seal-red","seal-white","seal-blue","seal-yellow","seal-red",
    "seal-white","seal-blue","seal-yellow","seal-red","seal-white",
    "seal-blue","seal-yellow","seal-red","seal-white","seal-blue",
    "seal-yellow","seal-red","seal-white","seal-blue","seal-yellow"
  ];

  // ======= 기본 기준 (합의값) =======
  const DEFAULT_BASE = { baseDate: "2025-07-26", baseKin: 34 };

  // ======= 유틸(UTC 안전) =======
  const toUTC = (y,m,d)=> new Date(Date.UTC(y,m-1,d));
  const ymd = (date)=> ({y:date.getUTCFullYear(), m:date.getUTCMonth()+1, d:date.getUTCDate()});
  const sameUTC = (a,b)=> a.getUTCFullYear()===b.getUTCFullYear() && a.getUTCMonth()===b.getUTCMonth() && a.getUTCDate()===b.getUTCDate();
  const parseYMD = (s)=>{ const [y,m,d]=s.split("-").map(Number); return toUTC(y,m,d); };
  const fmt2 = (n)=> String(n).padStart(2,"0");
  const fmtYMD = (date)=> { const {y,m,d}=ymd(date); return [y,fmt2(m),fmt2(d)].join("-"); };
  const diffDaysUTC = (a,b)=> Math.floor((a - b)/86400000);

  // ======= 로컬 스토리지 =======
  const loadBase = ()=> {
    try{
      const j = JSON.parse(localStorage.getItem("kin-base")||"{}");
      if(!j.baseDate || !j.baseKin) return {...DEFAULT_BASE};
      return j;
    }catch(_){ return {...DEFAULT_BASE}; }
  };
  const saveBase = (obj)=> localStorage.setItem("kin-base", JSON.stringify(obj));

  // ======= 13문 변환 =======
  function toThirteenMoon(date){
    const {y} = ymd(date);
    const doot = toUTC(y,7,25);
    if (sameUTC(date, doot)) return { isDOOT:true };

    const startThis = toUTC(y,7,26);
    const start = (date < startThis) ? toUTC(y-1,7,26) : startThis;

    const offset = diffDaysUTC(date, start); // 0-base
    const month = Math.floor(offset/28)+1;
    const day = (offset%28)+1;
    return { isDOOT:false, month, day, start };
  }

  // ======= Kin/톤/문양 =======
  function kinOf(date, base){
    const baseDate = parseYMD(base.baseDate);
    const days = diffDaysUTC(date, baseDate);
    let kin = ((days + base.baseKin - 1) % 260 + 260) % 260 + 1;
    const tone = ((kin - 1) % 13) + 1;
    const seal = ((kin - 1) % 20) + 1;
    return { kin, tone, seal };
  }

  // ======= SVG 인라인 주입(자동색상 적용을 위해) =======
  async function inlineSVG(el, src, extraClass=""){
    try{
      const res = await fetch(src);
      const txt = await res.text();
      el.innerHTML = txt; // svg 태그가 그대로 들어감
      if (extraClass) el.classList.add(...extraClass.split(" "));
      // svg 크기/색은 CSS로 제어( currentColor )
      const svg = el.querySelector("svg");
      if (svg){ svg.setAttribute("width","24"); svg.setAttribute("height","24"); }
    }catch(e){ /* 실패해도 무시 */ }
  }

  // ======= 엘리먼트 =======
  const $datePick = document.getElementById("datePick");
  const $btnToday = document.getElementById("btnToday");
  const $btnShare = document.getElementById("btnShare");
  const $todayCard = document.getElementById("todayCard");
  const $grid = document.getElementById("grid");
  const $moonMeta = document.getElementById("moonMeta");
  const $baseDate = document.getElementById("baseDate");
  const $baseKin  = document.getElementById("baseKin");
  const $btnSaveBase = document.getElementById("btnSaveBase");
  const $btnResetBase = document.getElementById("btnResetBase");

  // ======= 렌더 =======
  function render(date){
    const base = loadBase();
    $datePick.value = fmtYMD(date);

    const tm = toThirteenMoon(date);
    const kin = kinOf(date, base);

    if (tm.isDOOT){
      $todayCard.innerHTML = `
        <div class="doot">
          <div class="big">시간 밖의 날</div>
          <div class="muted">이 날은 13개월×28일 순환에 속하지 않는 ‘사이 날(7월 25일)’입니다.</div>
        </div>`;
      $moonMeta.textContent = "";
      $grid.innerHTML = "";
      return;
    }

    const moonName = MOON_NAMES[(tm.month-1)];
    const toneName = TONE_NAMES[(kin.tone-1)];
    const sealName = SEAL_NAMES[(kin.seal-1)];

    const g = ymd(date);

    // 헤더 카드 (아이콘 + 배지 + 툴팁 트리거)
    const sealSlug = SEAL_SLUGS[kin.seal-1];
    const sealColorClass = SEAL_COLOR[kin.seal-1];
    const sealPath = `./src/assets/seals/${sealSlug}.svg`;
    const tonePath = `./src/assets/tones/${String(kin.tone).padStart(2,"0")}.svg`;

    const header = `
      <div class="big">${tm.month}.${tm.day} <span class="muted">(${moonName})</span></div>
      <div class="muted" style="margin-top:4px">그레고리력: ${g.y}년 ${g.m}월 ${g.d}일 · 13문: ${tm.month}.${tm.day}</div>
      <div class="kinfo" style="margin-top:8px">
        <span class="kbadge" tabindex="0">Kin ${kin.kin}</span>

        <button class="kbadge tip" data-kind="tone" data-id="${kin.tone}">
          <span class="iconwrap icon-24" data-inline-svg="${tonePath}"></span>
          톤 ${toneName}
        </button>

        <button class="kbadge tip ${sealColorClass}" data-kind="seal" data-id="${kin.seal}">
          <span class="iconwrap icon-24 ${sealColorClass}" data-inline-svg="${sealPath}"></span>
          ${sealName}
        </button>
      </div>
      <div class="hint" style="margin-top:6px">(아이콘을 탭하면 간단 설명이 꼬리표로 뜹니다)</div>
    `;
    $todayCard.innerHTML = header;

    // 아이콘 인라인 주입(색상 적용)
    document.querySelectorAll("[data-inline-svg]").forEach(node=>{
      inlineSVG(node, node.getAttribute("data-inline-svg"), node.className);
    });

    // 그리드
    buildGrid(tm.start, tm.month, base);
    // 툴팁 바인딩
    bindTips();
  }

  function buildGrid(startOfYear, monthIndex, base){
    const first = new Date(startOfYear.getTime() + (monthIndex-1)*28*86400000);
    const cells = [];
    for(let i=0;i<28;i++){
      const d = new Date(first.getTime() + i*86400000);
      const {kin, tone, seal} = kinOf(d, base);
      const g = ymd(d);
      cells.push({d, gday:g.d, kin});
    }
    $moonMeta.textContent = `${MOON_NAMES[monthIndex-1]} — ${fmtYMD(first)} ~ ${fmtYMD(new Date(first.getTime()+27*86400000))}`;

    const todayUTC = toUTC(new Date().getUTCFullYear(), new Date().getUTCMonth()+1, new Date().getUTCDate());
    $grid.innerHTML = cells.map(c=>{
      const isToday = sameUTC(c.d, todayUTC);
      return `
        <div class="cell ${isToday?'is-today':''}">
          <div class="d">${c.gday}</div>
          <div class="muted" style="font-size:12px">Kin ${c.kin}</div>
        </div>`;
    }).join("");
  }

  // ======= 툴팁 =======
  let popEl = null;
  function closePop(){ if(popEl){ popEl.remove(); popEl = null; } }
  function showPop(target, title, text){
    closePop();
    popEl = document.createElement('div');
    popEl.className = 'pop';
    popEl.setAttribute('data-side','top');
    popEl.innerHTML = `<div class="ttl">${title}</div><div>${text}</div>`;
    document.body.appendChild(popEl);

    const r = target.getBoundingClientRect();
    const pad = 8;
    // 먼저 위치를 찍고 크기 읽기
    popEl.style.left = (r.left) + 'px';
    popEl.style.top  = (r.top - 10) + 'px';
    const pw = popEl.offsetWidth, ph = popEl.offsetHeight;

    const left = Math.max(8, Math.min(window.innerWidth - pw - 8, r.left));
    const top  = Math.max(8, r.top - ph - pad);
    popEl.style.left = left + 'px';
    popEl.style.top  = top + 'px';

    function onDoc(e){ if(!popEl.contains(e.target) && e.target!==target){ closePop(); document.removeEventListener('mousedown',onDoc,true); } }
    document.addEventListener('mousedown', onDoc, true);
  }
  function bindTips(){
    document.querySelectorAll('.tip').forEach(btn=>{
      btn.onclick = ()=>{
        const kind = btn.getAttribute('data-kind');
        const id = parseInt(btn.getAttribute('data-id'),10); // 1-based
        if(kind==='tone'){
          showPop(btn, `톤 ${TONE_NAMES[id-1]}`, TONE_BRIEF[id-1] || '');
        }else{
          showPop(btn, `${SEAL_NAMES[id-1]}`, SEAL_BRIEF[id-1] || '');
        }
      };
    });
  }

  // ======= 이벤트 =======
  $btnToday.onclick = ()=>{
    const now = toUTC(new Date().getUTCFullYear(), new Date().getUTCMonth()+1, new Date().getUTCDate());
    render(now);
  };
  $datePick.onchange = ()=> render(parseYMD($datePick.value));
  $btnShare.onclick = async ()=>{
    try{
      const text = document.querySelector("#todayCard").innerText.trim();
      if (navigator.share) { await navigator.share({text, title:"13문 캘린더"}); }
      else { await navigator.clipboard.writeText(text); alert("복사됨! 원하는 곳에 붙여넣기 하세요."); }
    }catch(_){}
  };

  // 기준 저장/초기화
  function syncBaseInputs(){
    const base = loadBase();
    $baseDate.value = base.baseDate;
    $baseKin.value = String(base.baseKin);
  }
  $btnSaveBase.onclick = ()=>{
    const bd = $baseDate.value || DEFAULT_BASE.baseDate;
    const bk = Math.max(1, Math.min(260, parseInt($baseKin.value||"34",10)));
    saveBase({baseDate: bd, baseKin: bk});
    alert("저장됨. 새 기준으로 반영됩니다.");
    render(parseYMD($datePick.value));
  };
  $btnResetBase.onclick = ()=>{
    saveBase({...DEFAULT_BASE});
    syncBaseInputs();
    alert("기본값으로 재설정됨.");
    render(parseYMD($datePick.value));
  };

  // ======= 시작 =======
  syncBaseInputs();
  const nowUTC = toUTC(new Date().getUTCFullYear(), new Date().getUTCMonth()+1, new Date().getUTCDate());
  document.getElementById("datePick").value = fmtYMD(nowUTC);
  render(nowUTC);
})();
</script>
</body>
</html>
