<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>í† íŠ¸ì˜ ë‹¬ë ¥ - 13 Moon Calendar (White Wizard)</title>
<link rel="manifest" href="./manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="í† íŠ¸ì˜ ë‹¬ë ¥">
<link rel="icon" href="./dreamspell_icon_512.png" sizes="512x512">
<link rel="apple-touch-icon" href="./dreamspell_icon_512.png">
<link rel="stylesheet" href="./src/assets/dreamspell.css" />
<style>
:root{--bg:#0b0b0c;--fg:#e9e9ea;--muted:#9aa0a6;--card:#141518;--acc:#cfd8e3;--line:#23252a}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Apple SD Gothic Neo,sans-serif}
.wrap{max-width:880px;margin:0 auto;padding:16px 16px 96px}
h1{font-size:22px;margin:0 0 6px;font-weight:800;letter-spacing:.2px;display:flex;align-items:center;justify-content:space-between}
h2{font-size:18px;margin:0 0 10px}
.muted{color:var(--muted)}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin:12px 0}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
input,button{border-radius:10px;border:1px solid #2a2c33;background:#1a1c21;color:var(--fg);padding:10px 12px}
button.primary{background:#1b2a33;border-color:#24414f}
.grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:10px}
.cell{background:#13151a;border:1px solid #262b31;border-radius:10px;padding:8px;min-height:62px;display:flex;flex-direction:column;justify-content:center;align-items:center}
.cell .gd{font-weight:800;font-size:16px}.cell .md{font-size:12px;color:var(--muted)}
.big{font-size:28px;font-weight:800;letter-spacing:0.2px}
.kinfo{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
.kbadge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:9px;background:#101318;border:1px solid #28303a;cursor:pointer}
.pill{display:inline-block;padding:4px 8px;border:1px solid #2c323a;border-radius:999px;background:#0f1216;font-size:12px;color:var(--muted)}
.pop{position:fixed;max-width:320px;background:#101318;border:1px solid #2a2f36;border-radius:10px;padding:10px 12px;box-shadow:0 6px 30px rgba(0,0,0,.35);z-index:9999;font-size:14px;line-height:1.45}
.pop .ttl{font-weight:800;margin-bottom:6px}.pop .sub{font-size:12px;color:var(--muted);margin-top:6px}
.pop::after{content:"";position:absolute;width:10px;height:10px;background:#101318;border-left:1px solid #2a2f36;border-top:1px solid #2a2f36;transform:rotate(45deg)}
.pop[data-side="top"]::after{bottom:-6px;left:16px}
.tabbar{position:fixed;left:0;right:0;bottom:0;background:#0d0e11;border-top:1px solid #1f232a;display:flex}
.tabbar button{flex:1;padding:12px 8px;background:transparent;border:0;color:var(--fg);font-weight:800}
.tabbar button[aria-selected="true"]{background:#121419}
.page{display:none}.page.active{display:block}
.badge{display:inline-block;padding:4px 8px;border:1px solid #2a2f36;border-radius:999px;background:#0f1216;font-size:12px;color:var(--muted)}
.list{display:grid;gap:10px}.item{display:flex;align-items:center;gap:12px;padding:12px;border:1px solid #2a2f36;border-radius:12px;background:#0f1116}
.item .meta{flex:1}.actions{display:flex;gap:8px}.ghost{background:transparent;border-color:#3a3f48}
.iconbtn{background:#0f1216;border:1px solid #2a2f36;border-radius:10px;padding:8px 10px}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:9998}
.modal .sheet{width:min(520px,90vw);background:#12141a;border:1px solid #2a2f36;border-radius:16px;padding:14px}
.close{float:right}
</style>
</head>
<body>
<div class="wrap">
  <h1><span>í† íŠ¸ì˜ ë‹¬ë ¥ <span class="muted">â€“ 13 Moon Calendar (White Wizard)</span></span></h1>

  <section id="page-calendar" class="page active">
    <div class="card">
      <div class="row">
        <input type="date" id="datePick" />
        <button class="primary" id="btnToday">ì˜¤ëŠ˜</button>
        <button id="btnShare">ê³µìœ </button>
      </div>
      <div id="todayCard" style="margin-top:10px"></div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <h2>ì´ ë‹¬(28ì¼ ê·¸ë¦¬ë“œ)</h2>
        <span id="legend" class="pill">ì…€=ì–‘ë ¥ / í•˜ë‹¨=13ë¬¸ M.D</span>
      </div>
      <div id="moonMeta" class="muted" style="margin:6px 0 10px"></div>
      <div id="grid" class="grid"></div>
      <div class="muted" style="margin-top:8px">* 13Ã—28=364. 7/25ëŠ” â€œì‹œê°„ ë°–ì˜ ë‚ â€.</div>
    </div>

    <div class="card">
      <h2>ê¸°ì¤€ & ì˜¤ëŠ˜ì˜ ì œì•ˆ</h2>
      <div class="row">
        <label style="flex:1">ê¸°ì¤€ì¼ <input type="date" id="baseDate"></label>
        <label style="flex:1">ê¸°ì¤€ Kin <input type="number" id="baseKin" min="1" max="260"></label>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="btnSaveBase" class="primary">ì €ì¥</button>
        <button id="btnResetBase">ê¸°ë³¸ê°’</button>
      </div>
      <div class="card" style="margin-top:12px">
        <h3 style="margin:0 0 6px">ì˜¤ëŠ˜ì˜ ì œì•ˆ</h3>
        <div id="advice"></div>
      </div>
    </div>
  </section>

  <section id="page-profiles" class="page">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <h2 style="margin:0">ì€í•˜ í”„ë¡œí•„</h2>
      <button id="btnAddProfile" class="iconbtn">ï¼‹</button>
    </div>
    <div class="card" style="margin-top:10px">
      <div class="list" id="profileList"></div>
      <div class="muted" style="margin-top:6px">ì—¬ëŸ¬ ì‚¬ëŒì˜ ìƒì¼ì„ ì €ì¥í•´ ë‘ê³  Kin/ì›¨ì´ë¸ŒìŠ¤í /í•´ì„ì„ ë¹ ë¥´ê²Œ ë³´ì„¸ìš”.</div>
    </div>
  </section>
</div>

<nav class="tabbar">
  <button id="tabCal" aria-selected="true">ìº˜ë¦°ë”</button>
  <button id="tabProfiles" aria-selected="false">ì€í•˜ í”„ë¡œí•„</button>
</nav>

<div id="modal" class="modal">
  <div class="sheet">
    <button id="mClose" class="iconbtn close">ë‹«ê¸°</button>
    <h3 style="margin-top:0">ì€í•˜ í”„ë¡œí•„ ì¶”ê°€</h3>
    <div class="row">
      <label style="flex:1">ì´ë¦„(ì„ íƒ) <input type="text" id="mName" placeholder="ì´ë¦„ ë˜ëŠ” ë³„ëª…"></label>
      <label style="flex:1">ìƒì¼(ì–‘ë ¥) <input type="date" id="mBirth"></label>
    </div>
    <div class="row" style="margin-top:8px">
      <label style="flex:1">ì¶œìƒì‹œê°„(ì„ íƒ) <input type="time" id="mTime"></label>
      <div style="flex:1"></div>
    </div>
    <div class="row" style="margin-top:12px"><button id="mSave" class="primary">ì €ì¥</button></div>
  </div>
</div>

<script>
(function(){
  const MOON_NAMES = ["1 ìê°ì˜ ë‹¬","2 ë„ì „ì˜ ë‹¬","3 ì„œë¹„ìŠ¤ì˜ ë‹¬","4 ìê¸°(í˜•íƒœ)ì˜ ë‹¬","5 í˜ì˜ ë‹¬","6 ê· í˜•ì˜ ë‹¬","7 ê³µëª…ì˜ ë‹¬","8 ë¬´ê²°ì„±ì˜ ë‹¬","9 ì˜ë„ì˜ ë‹¬","10 í˜„í˜„ì˜ ë‹¬","11 í•´ë°©ì˜ ë‹¬","12 í˜‘ë ¥ì˜ ë‹¬","13 ìš°ì£¼ì˜ ë‹¬"];
  const TONE_NAMES = ["1 ìê¸°","2 ë‹¬","3 ì „ê¸°","4 ìê¸°(í˜•íƒœ)","5 ë°œì‚°","6 ë¦¬ë“¬","7 ê³µëª…","8 ì€í•˜","9 íƒœì–‘","10 í–‰ì„±","11 ìŠ¤í™íŠ¸ëŸ´(í•´ë°©)","12 ìˆ˜ì •(í˜‘ë ¥)","13 ìš°ì£¼"];
  const SEAL_NAMES = ["1 ë¶‰ì€ ìš©","2 í° ë°”ëŒ","3 íŒŒë€ ë°¤","4 ë…¸ë€ ì”¨ì•—","5 ë¶‰ì€ ë±€","6 í° ì„¸ê³„ì—°ê²°ì","7 íŒŒë€ ì†","8 ë…¸ë€ ë³„","9 ë¶‰ì€ ë‹¬","10 í° ê°œ","11 íŒŒë€ ì›ìˆ­ì´","12 ë…¸ë€ ì¸ê°„","13 ë¶‰ì€ í•˜ëŠ˜ì—¬í–‰ì","14 í° ë§ˆë²•ì‚¬","15 íŒŒë€ ë…ìˆ˜ë¦¬","16 ë…¸ë€ ì „ì‚¬","17 ë¶‰ì€ ì§€êµ¬","18 í° ê±°ìš¸","19 íŒŒë€ í­í’","20 ë…¸ë€ íƒœì–‘"];
  const SEAL_SLUGS = ["01_red-dragon","02_white-wind","03_blue-night","04_yellow-seed","05_red-serpent","06_white-worldbridger","07_blue-hand","08_yellow-star","09_red-moon","10_white-dog","11_blue-monkey","12_yellow-human","13_red-skywalker","14_white-wizard","15_blue-eagle","16_yellow-warrior","17_red-earth","18_white-mirror","19_blue-storm","20_yellow-sun"];
  const SEAL_COLOR = ["seal-red","seal-white","seal-blue","seal-yellow","seal-red","seal-white","seal-blue","seal-yellow","seal-red","seal-white","seal-blue","seal-yellow","seal-red","seal-white","seal-blue","seal-yellow","seal-red","seal-white","seal-blue","seal-yellow"];
  const WAVE_NAMES = ["ë¶‰ì€ ìš©","í° ë°”ëŒ","íŒŒë€ ë°¤","ë…¸ë€ ì”¨ì•—","ë¶‰ì€ ë±€","í° ì„¸ê³„ì—°ê²°ì","íŒŒë€ ì†","ë…¸ë€ ë³„","ë¶‰ì€ ë‹¬","í° ê°œ","íŒŒë€ ì›ìˆ­ì´","ë…¸ë€ ì¸ê°„","ë¶‰ì€ í•˜ëŠ˜ì—¬í–‰ì","í° ë§ˆë²•ì‚¬","íŒŒë€ ë…ìˆ˜ë¦¬","ë…¸ë€ ì „ì‚¬","ë¶‰ì€ ì§€êµ¬","í° ê±°ìš¸","íŒŒë€ í­í’","ë…¸ë€ íƒœì–‘"];
  const TONE_BRIEF = ["ëª©ì Â·ì˜ì§€Â·í˜„ì¡´","ë„ì „Â·ê·¹ì„±Â·ê· í˜•","ë´‰ì‚¬Â·í™œì„±Â·ì˜ë„","í˜•íƒœÂ·ì •ì˜Â·í˜•ìƒí™”","í˜Â·ë³µì œÂ·ë°©ì‚¬","íë¦„Â·ê· í˜•Â·ì¡°ìœ¨","ê³µëª…Â·ì±„ë„ë§Â·ì¡°ìœ¨","ëª¨ë¸Â·ë¬´ê²°ì„±Â·ì¡°í™”","ì‹¤í˜„Â·ì˜ë„Â·ë¹›","í˜„í˜„Â·ì™„ì„±Â·ìƒì‚°","í•´ë°©Â·ìš©í•´Â·í•´ì²´","í˜‘ë ¥Â·ì¡°í•©Â·í—Œì‹ ","ìš°ì£¼Â·ì¡´ì¬Â·ì´ˆì›”"];
  const SEAL_BRIEF = ["íƒ„ìƒÂ·ì–‘ìœ¡Â·ê¸°ì´ˆ","ì†Œí†µÂ·í˜¸í¡Â·ì˜ê°","ê¿ˆÂ·í’ìš”Â·ì ì¬ì˜ì‹","ì”¨ì•—Â·ë°œì•„Â·ì ì¬ë ¥","ìƒëª…ë ¥Â·ë³¸ëŠ¥Â·ì •í™”","ë†“ì•„ë³´ëƒ„Â·ì£½ìŒÂ·ê¸°íšŒ","ì¹˜ìœ Â·ì™„ì„±Â·ì§€ì‹","ì•„ë¦„ë‹¤ì›€Â·ì˜ˆìˆ Â·ì¡°í™”","ì •í™”Â·íë¦„Â·ë¬¼","ì‚¬ë‘Â·ì¶©ì„±Â·ë§ˆìŒ","ìœ í¬Â·ë§ˆë²•Â·ì¬ì¹˜","ììœ ì˜ì§€Â·ì§€í˜œÂ·ì˜í–¥","íƒí—˜Â·ê³µê°„Â·ê°ì„±","ì£¼ìˆ Â·ì‹œê°„Â·ìˆ˜ìš©","ë¹„ì „Â·ì°½ê³µÂ·ë§ˆìŒì˜ ëˆˆ","ì§ˆë¬¸Â·ì§€ì„±Â·ëŒ€ë‹´","ë™ê¸°í™”Â·í•­ë²•Â·ì§€êµ¬","ë°˜ì˜Â·ì§ˆì„œÂ·ê²½ê³„","ë³€í˜•Â·ì´‰ë§¤Â·ì—ë„ˆì§€","ê³„ëª½Â·ìƒëª…Â·ë³´í¸ì  ë¶ˆ"];

  const DEFAULT_BASE = { baseDate: "2025-07-26", baseKin: 34 };

  const toUTC=(y,m,d)=>new Date(Date.UTC(y,m-1,d));
  const ymd=(d)=>({y:d.getUTCFullYear(),m:d.getUTCMonth()+1,d:d.getUTCDate()});
  const parseYMD=(s)=>{const [y,m,d]=s.split("-").map(Number);return toUTC(y,m,d)};
  const fmt2=(n)=>String(n).padStart(2,"0");
  const fmtYMD=(d)=>{const o=ymd(d);return [o.y,fmt2(o.m),fmt2(o.d)].join("-")};
  const sameUTC=(a,b)=>a.getUTCFullYear()===b.getUTCFullYear()&&a.getUTCMonth()===b.getUTCMonth()&&a.getUTCDate()===b.getUTCDate();
  const diffDaysUTC=(a,b)=>Math.floor((a-b)/86400000);

  const getBase=()=>{try{const j=JSON.parse(localStorage.getItem("kin-base")||"{}");return (j.baseDate&&j.baseKin)?j:DEFAULT_BASE}catch(e){return DEFAULT_BASE}};
  const saveBase=(b)=>localStorage.setItem("kin-base", JSON.stringify(b));

  function toThirteenMoon(date){
    const {y}=ymd(date);
    const doot=toUTC(y,7,25);
    if(sameUTC(date,doot)) return {isDOOT:true};
    const startThis=toUTC(y,7,26);
    const start=(date<startThis)?toUTC(y-1,7,26):startThis;
    const offset=diffDaysUTC(date,start);
    return {isDOOT:false, month:Math.floor(offset/28)+1, day:(offset%28)+1, start};
  }

  function kinOf(date, base){
    const baseDate=parseYMD(base.baseDate);
    const days=diffDaysUTC(date, baseDate);
    const kin=((days+base.baseKin-1)%260+260)%260+1;
    const tone=((kin-1)%13)+1;
    const seal=((kin-1)%20)+1;
    const waveIndex=Math.floor((kin-1)/13);
    const wavePos=((kin-1)%13)+1;
    return {kin,tone,seal,waveIndex,wavePos};
  }

  // Calendar
  const $datePick=document.getElementById("datePick");
  const $btnToday=document.getElementById("btnToday");
  const $btnShare=document.getElementById("btnShare");
  const $todayCard=document.getElementById("todayCard");
  const $grid=document.getElementById("grid");
  const $moonMeta=document.getElementById("moonMeta");
  const $baseDate=document.getElementById("baseDate");
  const $baseKin=document.getElementById("baseKin");
  const $btnSaveBase=document.getElementById("btnSaveBase");
  const $btnResetBase=document.getElementById("btnResetBase");
  const $advice=document.getElementById("advice");

  function buildAdvice(tm,k){
    const one = `ì˜¤ëŠ˜ì€ <b>${TONE_NAMES[k.tone-1]}</b>ì˜ ë¹›ìœ¼ë¡œ <b>${SEAL_NAMES[k.seal-1]}</b>ë¥¼ ì‚´ì•„ë‚´ëŠ” ë‚ ì…ë‹ˆë‹¤.`;
    const three = [
      `ğŸŒ™ <b>í•µì‹¬</b>: ${TONE_BRIEF[k.tone-1].split("Â·")[0]}ì˜ ì˜ì‹ìœ¼ë¡œ, ${SEAL_BRIEF[k.seal-1].split("Â·")[0]}ì„(ë¥¼) ê¸°ì–µí•˜ì„¸ìš”.`,
      `ğŸ’­ <b>ë§ˆìŒ</b>: ${SEAL_BRIEF[k.seal-1]}ì˜ í‚¤ì›Œë“œë¥¼ í˜¸í¡/ì–¸ì–´/ì‹œì„ ì— ë…¹ì—¬ë³´ì„¸ìš”.`,
      `ğŸŒ¿ <b>í–‰ë™</b>: ${TONE_NAMES[k.tone-1]}ì˜ ë¦¬ë“¬ì— ë§ì¶° í•œ ê°€ì§€ í–‰ë™ì„ ì™„ì„±í•˜ì„¸ìš”.`
    ].join("<br>");
    return `<div style="line-height:1.6">${one}<br><div class="muted" style="margin:6px 0">(${MOON_NAMES[tm.month-1]})</div>${three}</div>`;
  }

  function buildGrid(startOfYear, monthIndex, base){
    const first = new Date(startOfYear.getTime() + (monthIndex-1)*28*86400000);
    const todayUTC=toUTC(new Date().getUTCFullYear(), new Date().getUTCMonth()+1, new Date().getUTCDate());
    let html="";
    for(let i=0;i<28;i++){
      const d=new Date(first.getTime()+i*86400000);
      const g=ymd(d);
      const tm=toThirteenMoon(d);
      const {kin}=kinOf(d, getBase());
      const isToday=sameUTC(d,todayUTC);
      html+=`<div class="cell ${isToday?'is-today':''}" title="Kin ${kin}"><div class="gd">${g.d}</div><div class="md">${tm.month}.${tm.day}</div></div>`;
    }
    const from=fmtYMD(first); const to=fmtYMD(new Date(first.getTime()+27*86400000));
    $moonMeta.textContent = `${MOON_NAMES[monthIndex-1]} â€” ${from} ~ ${to}`;
    $grid.innerHTML = html;
  }

  let popEl=null;
  function closePop(){ if(popEl){ popEl.remove(); popEl=null; } }
  function showPop(target,title,body,sub=""){
    closePop();
    const el=document.createElement("div");
    el.className="pop"; el.setAttribute("data-side","top");
    el.innerHTML=`<div class="ttl">${title}</div><div>${body}</div>${sub?`<div class="sub">${sub}</div>`:""}`;
    document.body.appendChild(el);
    const r=target.getBoundingClientRect(), pad=8;
    const pw=el.offsetWidth, ph=el.offsetHeight;
    const left=Math.max(8, Math.min(window.innerWidth-pw-8, r.left));
    const top=Math.max(8, r.top - ph - pad);
    el.style.left=left+'px'; el.style.top=top+'px';
    function onDoc(e){ if(!el.contains(e.target) && e.target!==target){ closePop(); document.removeEventListener('mousedown', onDoc, true);} }
    document.addEventListener('mousedown', onDoc, true);
    popEl=el;
  }
  function bindTips(date, base){
    const kb=document.getElementById("kbKin");
    if(kb){
      kb.onclick=()=>{
        const k=kinOf(date, getBase());
        showPop(kb, `Kin ${k.kin}`, `${TONE_NAMES[k.tone-1]} Ã— ${SEAL_NAMES[k.seal-1]}`);
      }
    }
  }

  function render(date){
    const base=getBase();
    $datePick.value=fmtYMD(date);
    const tm=toThirteenMoon(date);
    if(tm.isDOOT){ $todayCard.innerHTML='<div class="card">ì‹œê°„ ë°–ì˜ ë‚ </div>'; $grid.innerHTML=""; return; }
    const k=kinOf(date, base);
    const g=ymd(date);
    $todayCard.innerHTML = `
      <div class="big">${tm.month}.${tm.day} <span class="muted">(${MOON_NAMES[tm.month-1]})</span></div>
      <div class="muted" style="margin-top:4px">ê·¸ë ˆê³ ë¦¬ë ¥: ${g.y}-${fmt2(g.m)}-${fmt2(g.d)} Â· 13ë¬¸: ${tm.month}.${tm.day}</div>
      <div class="kinfo" style="margin-top:8px">
        <span class="kbadge" id="kbKin">Kin ${k.kin}</span>
        <span class="badge">${WAVE_NAMES[k.waveIndex]} ì›¨ì´ë¸ŒìŠ¤í  Â· ${k.wavePos}/13</span>
      </div>`;
    buildGrid(tm.start, tm.month, base);
    bindTips(date, base);
    $advice.innerHTML = buildAdvice(tm, k);
  }

  // Tabs
  const $tabCal=document.getElementById("tabCal");
  const $tabProfiles=document.getElementById("tabProfiles");
  const $pageCal=document.getElementById("page-calendar");
  const $pageProfiles=document.getElementById("page-profiles");
  function setTab(which){
    const cal=which==='cal';
    $pageCal.classList.toggle('active',cal);
    $pageProfiles.classList.toggle('active',!cal);
    $tabCal.setAttribute('aria-selected', cal?'true':'false');
    $tabProfiles.setAttribute('aria-selected', !cal?'true':'false');
  }
  $tabCal.onclick=()=>setTab('cal');
  $tabProfiles.onclick=()=>setTab('profiles');

  // Profiles store
  const LS_KEY="galacticProfiles";
  const getProfiles=()=>{ try{ return JSON.parse(localStorage.getItem(LS_KEY)||"[]"); }catch(e){ return [];} };
  const saveProfiles=(arr)=>localStorage.setItem(LS_KEY, JSON.stringify(arr));

  function addProfile(name,birth,time){
    if(!birth) return;
    const base=getBase();
    const d=parseYMD(birth);
    const k=kinOf(d, base);
    const tm=toThirteenMoon(d);
    const p={ id:Date.now(), name:name||"", birth, time:time||"", kin:k.kin, tone:k.tone, seal:k.seal, waveIndex:k.waveIndex, wavePos:k.wavePos, moon:tm.month, moonDay:tm.day };
    const arr=getProfiles(); arr.push(p); saveProfiles(arr); renderProfileList();
  }
  function deleteProfile(id){ const arr=getProfiles().filter(p=>p.id!==id); saveProfiles(arr); renderProfileList(); }

  function interpret(p){
    const toneTxt=TONE_NAMES[p.tone-1], sealTxt=SEAL_NAMES[p.seal-1];
    const toneKey=TONE_BRIEF[p.tone-1], sealKey=SEAL_BRIEF[p.seal-1];
    const waveTxt=WAVE_NAMES[p.waveIndex];
    const special = (p.tone===13 && p.seal===16) ?
      "ìš°ì£¼ ë…¸ë€ ì „ì‚¬ëŠ” ìµœê³ ì˜ ì˜ì  ì „ì‚¬ì…ë‹ˆë‹¤. ë‘ë ¤ì›€ ì—†ì´ ì§„ì‹¤ì„ íƒêµ¬í•˜ê³  ì§ˆë¬¸ìœ¼ë¡œ ê¸¸ì„ ì—½ë‹ˆë‹¤. ë†’ì€ ì§€ì„±ê³¼ í†µì°°ë ¥ìœ¼ë¡œ íƒ€ì¸ì„ ê³ ì–‘ì‹œí‚¤ë©°, ë¬¼ì§ˆê³¼ ì˜ì„±ì„ ì‡ëŠ” ë‹¤ë¦¬ ì—­í• ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤." : "";
    const toneMsg = (p.tone===13) ? "ì™„ì„±ê³¼ ì´ˆì›”ì˜ ì—ë„ˆì§€ë¡œ, ì¡´ì¬ ìì²´ê°€ ë©”ì‹œì§€ì…ë‹ˆë‹¤." :
                    (p.tone===11)? "í•´ë°©ì˜ ë°”ëŒìœ¼ë¡œ ë¶ˆí•„ìš”í•œ ê²ƒì„ ë¹„ì›Œ ë³¸ì§ˆì„ ë“œëŸ¬ëƒ…ë‹ˆë‹¤." :
                    (p.tone===4) ? "í˜•íƒœì™€ ì§ˆì„œë¥¼ ì„¸ì›Œ íë¦„ì„ êµ¬ì¡°í™”í•©ë‹ˆë‹¤." :
                    TONE_BRIEF[p.tone-1];
    const sealMsg = (p.seal===16) ? "ì§€ì„±ìœ¼ë¡œ ë‘ë ¤ì›€ì„ ê±´ë„ˆ ì§ˆë¬¸ì„ í†µí•´ ì§„ì‹¤ì„ ì—°ë‹¤." :
                    (p.seal===3)  ? "ê¿ˆê³¼ ì ì¬ì˜ í’ìš”ë¥¼ í˜„ì‹¤ë¡œ ëŒì–´ì˜¨ë‹¤." :
                    (p.seal===14) ? "ì‹œê°„ ì˜ì‹ê³¼ ìˆ˜ìš©ì„±ìœ¼ë¡œ í˜„ì¬ë¥¼ ì •í™”í•œë‹¤." :
                    (p.seal===20) ? "ë¹›ê³¼ ìƒëª…ì˜ì‹ìœ¼ë¡œ ì¡´ì¬ë¥¼ ê³„ëª½í•œë‹¤." :
                    SEAL_BRIEF[p.seal-1];

    return `
      <div class="card">
        <h3 style="margin:0 0 8px">ì€í•˜ ì„œëª…: KIN ${p.kin} - ${toneTxt} ${sealTxt}</h3>
        <div class="muted" style="margin-bottom:6px">
          â€¢ í‚¤ì›Œë“œ(í†¤): ${toneKey}<br>
          â€¢ í‚¤ì›Œë“œ(ì¸ì¥): ${sealKey}<br>
          â€¢ ì›¨ì´ë¸ŒìŠ¤í : ${waveTxt} (${p.wavePos}/13)<br>
          â€¢ íƒ„ìƒ 13ë¬¸ ë‚ ì§œ: ${p.moon}.${p.moonDay} (${MOON_NAMES[p.moon-1]})
        </div>
        <h4 style="margin:8px 0 6px">ì¢…í•© í•´ì„</h4>
        <div>${special || `ë‹¹ì‹ ì€ <b>${toneTxt}</b>ì˜ ì¥ì—ì„œ <b>${sealTxt}</b>ì˜ ì§€í˜œë¥¼ êµ¬í˜„í•©ë‹ˆë‹¤. ${sealMsg} ${toneMsg}`}</div>
      </div>`;
  }

  function renderProfileList(){
    const list=document.getElementById("profileList");
    const arr=getProfiles();
    if(!arr.length){ list.innerHTML='<div class="muted">ì•„ì§ ì €ì¥ëœ í”„ë¡œí•„ì´ ì—†ìŠµë‹ˆë‹¤. ìš°ì¸¡ ìƒë‹¨ ï¼‹ ë²„íŠ¼ìœ¼ë¡œ ì¶”ê°€í•˜ì„¸ìš”.</div>'; return; }
    list.innerHTML = arr.sort((a,b)=>a.name.localeCompare(b.name)).map(p=>`
      <div class="item">
        <img src="./icon_person_info.png" width="36" height="36" alt="person"/>
        <div class="meta">
          <div style="font-weight:800">${p.name||'ì´ë¦„ ì—†ìŒ'}</div>
          <div class="muted" style="font-size:13px">${p.birth} Â· Kin ${p.kin} â€” ${TONE_NAMES[p.tone-1]} Ã— ${SEAL_NAMES[p.seal-1]} Â· ${WAVE_NAMES[p.waveIndex]} ${p.wavePos}/13</div>
        </div>
        <div class="actions">
          <button class="ghost" data-act="view" data-id="${p.id}">ë“œë¦¼ìŠ¤í  í•´ì„</button>
          <button class="ghost" data-act="del" data-id="${p.id}">ì‚­ì œ</button>
        </div>
      </div>`).join("");

    list.querySelectorAll("button").forEach(btn=>{
      const id=parseInt(btn.getAttribute("data-id"),10);
      const act=btn.getAttribute("data-act");
      btn.onclick=()=>{
        const p=getProfiles().find(x=>x.id===id); if(!p) return;
        if(act==="del"){ if(confirm("ì‚­ì œí• ê¹Œìš”?")) deleteProfile(id); }
        if(act==="view"){
          const host=document.createElement('div');
          host.className='modal'; host.style.display='flex';
          host.innerHTML=`<div class="sheet"><button class="iconbtn close" id="ivClose">ë‹«ê¸°</button>${interpret(p)}</div>`;
          document.body.appendChild(host);
          host.querySelector('#ivClose').onclick=()=>host.remove();
          host.onclick=(e)=>{ if(e.target===host) host.remove(); };
        }
      };
    });
  }

  // Modal
  const $modal=document.getElementById("modal");
  document.getElementById("btnAddProfile").onclick=()=>{ $modal.style.display='flex'; };
  document.getElementById("mClose").onclick=()=>{ $modal.style.display='none'; };
  $modal.onclick=(e)=>{ if(e.target===$modal) $modal.style.display='none'; };
  document.getElementById("mSave").onclick=()=>{
    const name=document.getElementById("mName").value.trim();
    const birth=document.getElementById("mBirth").value;
    const time=document.getElementById("mTime").value;
    if(!birth){ alert("ìƒì¼ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”"); return; }
    addProfile(name,birth,time);
    document.getElementById("mName").value="";document.getElementById("mBirth").value="";document.getElementById("mTime").value="";
    $modal.style.display='none';
  };

  // Init
  const nowUTC=toUTC(new Date().getUTCFullYear(), new Date().getUTCMonth()+1, new Date().getUTCDate());
  function syncBaseInputs(){ const b=getBase(); document.getElementById("baseDate").value=b.baseDate; document.getElementById("baseKin").value=String(b.baseKin); }
  document.getElementById("btnSaveBase").onclick=()=>{ const bd=document.getElementById("baseDate").value||DEFAULT_BASE.baseDate; const bk=Math.max(1,Math.min(260,parseInt(document.getElementById("baseKin").value||"34",10))); saveBase({baseDate:bd, baseKin:bk}); alert("ì €ì¥ë¨."); render(nowUTC); };
  document.getElementById("btnResetBase").onclick=()=>{ saveBase({...DEFAULT_BASE}); syncBaseInputs(); alert("ê¸°ë³¸ê°’ìœ¼ë¡œ ì¬ì„¤ì •."); render(nowUTC); };
  document.getElementById("datePick").value=fmtYMD(nowUTC);
  document.getElementById("btnToday").onclick=()=>render(nowUTC);
  document.getElementById("datePick").onchange=()=>render(parseYMD(document.getElementById("datePick").value));
  document.getElementById("btnShare").onclick=async()=>{ const text=document.querySelector("#todayCard").innerText.trim(); if(navigator.share) await navigator.share({title:"í† íŠ¸ì˜ ë‹¬ë ¥", text}); else { await navigator.clipboard.writeText(text); alert("ë³µì‚¬ë¨!"); } };

  syncBaseInputs();
  render(nowUTC);
  renderProfileList();

  if('serviceWorker' in navigator){ window.addEventListener('load', ()=>{ navigator.serviceWorker.register('./service-worker.js').catch(()=>{}); }); }
})();
</script>
</body>
</html>
